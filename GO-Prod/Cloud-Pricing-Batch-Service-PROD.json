{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS CloudFormation Template to create Spot based Compute environmnet, Job queue and Job Definition for EXE environmnet",
    "Parameters": {
        "PONumber": {
            "Description": "PO Number for billing",
            "Type": "String",
            "Default": "7000002358",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "ApplicationID": {
            "Description": "Application ID - Official Application_ID, this is generated by Sysco's CMDB",
            "Type": "String",
            "Default": "APP-001151",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "ApplicationName": {
            "Description": "Application_Name - Common, user-friendly name",
            "Type": "String",
            "Default": "Cloud Pricing",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "ApplicationRole": {
            "Default": "Batch Compute Environment",
            "Description": "The type of application stack",
            "Type": "String"
        },
        "Component": {
            "Description": "Component name",
            "Type": "String",
            "Default": "CP Batch",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "Approver": {
            "Description": "Person approving instance funding.  This should be Email address formatted",
            "Type": "String",
            "Default": "villanueva.loi@corp.sysco.com",
            "MinLength": "1",
            "MaxLength": "255"
        },
        "Owner": {
            "Description": "Email address usually Product/ Platform Owner, though team distribution list for technical product/platform team contact",
            "Type": "String",
            "Default": "krishan.senevirathne@sysco.com",
            "MinLength": "1",
            "MaxLength": "255"
        },
        "SupportEmail": {
            "Description": "Email distribution list for technical product/platform team contact",
            "Type": "String",
            "Default": "000-BT-PricingPlatform@Corp.sysco.com",
            "MinLength": "1",
            "MaxLength": "255"
        },
        "ProjectID": {
            "Description": "Project_ID - BT Project ID for this workload",
            "Type": "String",
            "Default": "BT.001176",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "2WTAGGER": {
            "Description": "Used by 2nd Watch Managed Services in shared accounts to determine if a resource is supported",
            "Type": "String",
            "Default": "team_managed",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedValues": [
                "team_managed",
                "adlm_managed",
                "2w_managed"
            ],
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "Platform": {
            "Description": "Platform",
            "Type": "String",
            "Default": "Cloud Pricing V4"
        },
        "Environment": {
            "Description": "Name of logical build environment designated for service.",
            "Type": "String",
            "Default": "Production",
            "AllowedValues": [
                "Development",
                "Quality",
                "Staging",
                "Tuning",
                "Execution",
                "Production"
            ],
            "ConstraintDescription": "Must be a valid environment."
        },
        "EnvironmentShort": {
            "Description": "Environment for application",
            "Type": "String",
            "Default": "PROD",
            "AllowedValues": [
                "DEV",
                "QA",
                "STG",
                "EXE",
                "TST",
                "PROD"
            ],
            "ConstraintDescription": "Must be a valid environment."
        },
        "PvtSNa": {
            "Description": "Private PRCP-Prod Confidential Subnet 1 in us-east-1a CIDR: 10.132.88.0/24",
            "Type": "String",
            "Default": "subnet-03f5516cc0d29f5ad"
        },
        "PvtSNb": {
            "Description": "Private PRCP-Prod Confidential Subnet 2 in us-east-1b CIDR: 10.132.89.0/24",
            "Type": "String",
            "Default": "subnet-094d9ade488a4f20b"
        },
        "PvtSNc": {
            "Description": "Private PRCP-Prod Confidential Subnet 3 in us-east-1c CIDR: 10.132.89.0/24",
            "Type": "String",
            "Default": "subnet-0f279e0609eb542b2"
        },
        "PubSNa": {
            "Description": "Public PRCP-Prod Subnet 1 in us-east-1a CIDR: 10.132.91.0/25",
            "Type": "String",
            "Default": "subnet-061215b5e4c9c00f5"
        },
        "PubSNb": {
            "Description": "Public PRCP-Prod Subnet 2 in us-east-1b CIDR: 10.132.91.128/25",
            "Type": "String",
            "Default": "subnet-0a931836475739532"
        },
        "VPCID": {
            "Description": "Name of and existing VPC",
            "Type": "String",
            "Default": "vpc-0f55b12524f7459f9"
        },
        "SGDNS": {
            "Description": "PRCP-DNS-DNSSG-1LVAMR19KIKFS",
            "Type": "String",
            "Default": "sg-086420a2869e44e81"
        },
        "SGRDSMySQL": {
            "Description": "SG-RDSMySQL",
            "Type": "String",
            "Default": "sg-0914feb8b95bd48c7"
        },
        "SGWebServices": {
            "Description": "SG-WebServices",
            "Type": "String",
            "Default": "sg-0abcdcef90427fcd7"
        },
        "SGELBs": {
            "Description": "SG-ELBs",
            "Type": "String",
            "Default": "sg-01b6a8878e22de7a0"
        },
        "PemKey": {
            "Description": "Name of and existing EC2 KeyPair to enable SSH access to the instance",
            "Type": "String",
            "Default": "KeyPair-Sysco-CloudPricing-Prod"
        },
        "CommonAMI": {
            "Description": "CP-Linux-Base-20181112 -> ami-029b4991ba32498b2",
            "Type": "String",
            "Default": "ami-029b4991ba32498b2",
            "AllowedPattern": "^ami-[0-9a-fA-F]{17}",
            "ConstraintDescription": "Must be a valid AMI."
        },
        "BatchServiceRole" : {
            "Type" : "String",
            "Description" : "Cloud-Pricing-Batch-Service-Role",
            "Default": "arn:aws:iam::130227353653:role/Cloud-Pricing-IAM-Batch-Service-Role"
        },
        "AWSBatchJobRole" : {
            "Type" :"String",
            "Description" : "IAM role for batch jobs",
            "Default": "arn:aws:iam::130227353653:role/CloudPricing-IAM-ECS-Task-Role"
        },
        "IamInstanceProfile" : {
            "Type" :"String",
            "Description" : "Instance profile foe CP batch pricing",
            "Default": "Cloud-Pricing-IAM-ECS-Instance-Profile"
        },
        "EcsInstanceRole" : {
            "Type" :"String",
            "Description" : "ECS instance role for CP batch pricing",
            "Default": "arn:aws:iam::130227353653:role/Cloud-Pricing-IAM-ECS-Instance-Role"
        },
        "AmazonEC2SpotFleetRole" : {
            "Type" :"String",
            "Description" : "EC2 spot fleet tagging role for CP  batch pricing",
            "Default": "arn:aws:iam::130227353653:role/CloudPricing-IAM-EC2-Spot-Fleet-Tagging-Role"
        }
    },
    "Resources": {
        "JobDefinition": {
            "Type": "AWS::Batch::JobDefinition",
            "Properties": {
                "Type": "container",
                "JobDefinitionName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-Job-Definition-",
                            {
                                "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                },
                "RetryStrategy": {
                    "Attempts": 2
                },
                "Timeout": {
                    "AttemptDurationSeconds" : 21600
                },
                "ContainerProperties": {
                    "Image": "sysco/cp-batch",
                    "Vcpus": 1,
                    "Memory": 1000,
                    "Privileged": true,
                    "JobRoleArn": "arn:aws:iam::130227353653:role/CloudPricing-IAM-ECS-Task-Role"
                }
            }
        },
        "JobQueueLow": {
            "Type": "AWS::Batch::JobQueue",
            "Properties": {
                "State": "ENABLED",
                "JobQueueName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-P25-Priority-Queue-",
                            {
                                "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                },
                "Priority": 25,
                "ComputeEnvironmentOrder": [
                    {
                        "Order": 1,
                        "ComputeEnvironment": {
                            "Ref": "CPBatchSpotOptimalComputeEnvironment"
                        }
                    }
                ]
            }
        },
        "JobQueueMedium": {
            "Type": "AWS::Batch::JobQueue",
            "Properties": {
                "State": "ENABLED",
                "JobQueueName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-P50-Priority-Queue-",
                            {
                                "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                },
                "Priority": 50,
                "ComputeEnvironmentOrder": [
                    {
                        "Order": 1,
                        "ComputeEnvironment": {
                            "Ref": "CPBatchSpotOptimalComputeEnvironment"
                        }
                    }
                ]
            }
        },
        "JobQueueHigh": {
            "Type": "AWS::Batch::JobQueue",
            "Properties": {
                "State": "ENABLED",
                "JobQueueName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-P75-Priority-Queue-",
                            {
                                "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                },
                "Priority": 75,
                "ComputeEnvironmentOrder": [
                    {
                        "Order": 1,
                        "ComputeEnvironment": {
                            "Ref": "CPBatchSpotOptimalComputeEnvironment"
                        }
                    }
                ]
            }
        },
        "CPBatchSpotOptimalComputeEnvironment": {
            "Type": "AWS::Batch::ComputeEnvironment",
            "Properties": {
                "Type": "MANAGED",
                "ServiceRole": {
                    "Ref": "BatchServiceRole"
                },
                "ComputeEnvironmentName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-Compute-Environment-",
                            {
                                "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                },
                "ComputeResources": {
                    "Type": "EC2",
                    "BidPercentage": 100,
                    "MinvCpus": 0,
                    "DesiredvCpus": 4,
                    "MaxvCpus": 200,
                    "InstanceTypes": [
                        "optimal"
                    ],
                    "Ec2KeyPair": {
                        "Ref": "PemKey"
                    },
                    "ImageId": {
                        "Ref": "CommonAMI"
                    },
                    "InstanceRole": {
                        "Ref": "IamInstanceProfile"
                    },
                    "SpotIamFleetRole": {
                        "Ref": "AmazonEC2SpotFleetRole"
                    },
                    "Subnets": [
                        {
                            "Ref": "PvtSNa"
                        }
                    ],
                    "SecurityGroupIds": [
                        {
                            "Ref": "SGDNS"
                        },
                        {
                            "Ref": "SGWebServices"
                        }
                    ],
                    "Tags":
                    {
                        "Technical:ApplicationName": {
                            "Ref": "ApplicationName"
                        }
                    ,

                        "Technical:ApplicationID": {
                            "Ref": "ApplicationID"
                        }
                    ,
                        "Technical:ApplicationRole": {
                            "Ref": "ApplicationRole"
                        }
                    ,
                        "Technical:ApplicationSubName": {
                            "Ref": "Component"
                        }
                    ,
                        "Technical:PlatformOwner": {
                            "Ref": "Owner"
                        }
                    ,

                        "Technical:Environment": {
                            "Ref": "Environment"
                        }
                    ,

                        "Name": {
                            "Ref": "Component"
                        }
                    ,
                        "Approver": {
                            "Ref": "Approver"
                        }
                    ,

                        "PO_Number": {
                            "Ref": "PONumber"
                        }
                    ,

                        "Project_ID": {
                            "Ref": "ProjectID"
                        }
                    ,

                        "Support_Email": {
                            "Ref": "SupportEmail"
                        }
                    ,

                        "2WTAGGER": {
                            "Ref": "2WTAGGER"
                        }
                    ,

                        "Platform": {
                            "Ref": "Platform"
                        }
                    ,

                        "Component": {
                            "Ref": "Component"
                        }
                    }
                },
                "State": "ENABLED"
            }
        }
    }
}