AWSTemplateFormatVersion: 2010-09-09
Description: CIPZ-API - SES Configurations
Parameters:
  ApplicationID:
    Description: Application ID - Official Application_ID, this is generated by Sysco's CMDB
    Type: String
    Default: APP-001151
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: "[\\x20-\\x7E]*"
    ConstraintDescription: Must contain only ASCII characters.
  ApplicationName:
    Description: Application_Name - Common, user-friendly name
    Type: String
    Default: Cloud Pricing
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: "[\\x20-\\x7E]*"
    ConstraintDescription: Must contain only ASCII characters.
  PONumber:
    Description: PO Number for billing
    Type: String
    Default: '7000002358'
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '[\x20-\x7E]*'
    ConstraintDescription: Must contain only ASCII characters.
  Approver:
    Description: Person approving instance funding.  This should be Email address
      formatted
    Type: String
    Default: villanueva.loi@corp.sysco.com
    MinLength: '1'
    MaxLength: '255'
  Owner:
    Description: Email address usually Product/ Platform Owner, though team distribution
      list for technical product/platform team contact
    Type: String
    Default: krishan.senevirathne@sysco.com
    MinLength: '1'
    MaxLength: '255'
  SupportEmail:
    Description: Email distribution list for technical product/platform team contact
    Type: String
    Default: 000-BT-PricingPlatform@Corp.sysco.com
    MinLength: '1'
    MaxLength: '255'
  ProjectID:
    Description: Project_ID - BT Project ID for this workload
    Type: String
    Default: BT.001176
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: "[\\x20-\\x7E]*"
    ConstraintDescription: Must contain only ASCII characters.
  Platform:
    Description: Platform
    Type: String
    Default: Cloud Pricing V4

  Environment:
    Description: Environment for application
    Type: String
    Default: DEV
    AllowedValues:
      - DEV
      - EXE
      - STG
      - PROD
    ConstraintDescription: Must be a valid environment.
  ConfigSetName:
    Type: String
    Default: configset
    Description: Configuration Set Name (Suffix Part only)
  EventDestinationName:
    Type: String
    AllowedPattern: "[a-zA-Z-_][a-zA-Z0-9-_]*"
    Default: cipz-ses-eventdestination

  SendType:
    Default: true
    AllowedValues:
      - true
      - false
    Type: String
  RejectType:
    Default: true
    AllowedValues:
      - true
      - false
    Type: String
  DeliveryType:
    Default: true
    AllowedValues:
      - true
      - false
    Type: String
  BounceType:
    Default: true
    AllowedValues:
      - true
      - false
    Type: String
  ComplaintType:
    Default: true
    AllowedValues:
      - true
      - false
    Type: String
  RenderingFailureType:
    Default: true
    AllowedValues:
      - true
      - false
    Type: String
  RenderingSuccessType:
    Default: false
    AllowedValues:
      - true
      - false
    Type: String

  DimensionName1:
    Default: application-name
    Type: String
    AllowedPattern: "[a-zA-Z-_][a-zA-Z0-9-_]*"
  DimensionName2:
    Default: email-category
    Type: String
    AllowedPattern: "[a-zA-Z-_][a-zA-Z0-9-_]*"
  DefaultDimensionValue1:
    Default: cipz-api-
    Type: String
    AllowedPattern: "[a-zA-Z-_][a-zA-Z0-9-_]*"
  DefaultDimensionValue2:
    Default: price-request-rejection
    Type: String
    AllowedPattern: "[a-zA-Z-_][a-zA-Z0-9-_]*"

  DimensionValueSource:
    Default: messageTag
    AllowedValues:
      - messageTag
      - emailHeader
    Type: String

Mappings:
  environmentLowercaseMap:
    DEV:
      environmentLowercaseStr: dev
    EXE:
      environmentLowercaseStr: exe
    STG:
      environmentLowercaseStr: stg
    PROD:
      environmentLowercaseStr: prod

Conditions:
  HasSendType:
    Fn::Not:
      - Fn::Equals:
          - 'false'
          - Ref: SendType
  HasRejectType:
    Fn::Not:
      - Fn::Equals:
          - 'false'
          - Ref: RejectType
  HasDeliveryType:
    Fn::Not:
      - Fn::Equals:
          - 'false'
          - Ref: DeliveryType
  HasBounceType:
    Fn::Not:
      - Fn::Equals:
          - 'false'
          - Ref: BounceType
  HasComplaintType:
    Fn::Not:
      - Fn::Equals:
          - 'false'
          - Ref: ComplaintType
  HasRenderingFailureType:
    Fn::Not:
      - Fn::Equals:
          - 'false'
          - Ref: RenderingFailureType
  HasRenderingSuccessType:
    Fn::Not:
      - Fn::Equals:
          - 'false'
          - Ref: RenderingSuccessType

Resources:
  BounceNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      TopicName: !Join ["-",["cipz-api",!FindInMap [environmentLowercaseMap, !Ref "Environment", environmentLowercaseStr],"ses-bounce-topic"]]
      Tags:
        - Key: Technical:ApplicationName
          Value:
            Ref: ApplicationName
        - Key: Technical:ApplicationID
          Value:
            Ref: ApplicationID
        - Key: PONumber
          Value:
            Ref: PONumber
        - Key: Approver
          Value:
            Ref: Approver
        - Key: Technical:PlatformOwner
          Value:
            Ref: Owner
        - Key: ProjectID
          Value:
            Ref: ProjectID
        - Key: Technical:Environment
          Value:
            Ref: Environment

  ConfigSet:
    Type: AWS::SES::ConfigurationSet
    Properties:
      Name: !Join ["-",["cipz-api",!FindInMap [environmentLowercaseMap, !Ref "Environment", environmentLowercaseStr],!Ref ConfigSetName]]

  EventDestinationConfigSet:
    # Contains the dimension configuration to use when you publish email sending events to Amazon CloudWatch.
    Type: AWS::SES::ConfigurationSetEventDestination # Specifies a configuration set event destination. An event destination is an AWS service that Amazon SES publishes email sending events to. When you specify an event destination, you provide one, and only one, destination. You can send event data to Amazon CloudWatch or Amazon Kinesis Data Firehose.
    Properties:
      ConfigurationSetName: !Ref ConfigSet
      EventDestination: 
        Name: !Join ["-",[!FindInMap [environmentLowercaseMap, !Ref "Environment", environmentLowercaseStr],!Ref EventDestinationName]]
        CloudWatchDestination:
          DimensionConfigurations:
            - DimensionName: !Ref DimensionName1
              DimensionValueSource: !Ref DimensionValueSource
              DefaultDimensionValue: !Ref DefaultDimensionValue1
            - DimensionName: !Ref DimensionName2
              DimensionValueSource: !Ref DimensionValueSource
              DefaultDimensionValue: !Ref DefaultDimensionValue2
        Enabled: true
        MatchingEventTypes: 
          - Fn::If:
              - HasSendType
              - send
              - !Ref AWS::NoValue
          - Fn::If:
              - HasRejectType
              - reject
              - !Ref AWS::NoValue
          - Fn::If:
              - HasDeliveryType
              - delivery
              - !Ref AWS::NoValue
          - Fn::If:
              - HasBounceType
              - bounce
              - !Ref AWS::NoValue
          - Fn::If:
              - HasComplaintType
              - complaint
              - !Ref AWS::NoValue
          - Fn::If:
              - HasRenderingFailureType
              - renderingFailure
              - !Ref AWS::NoValue
          - Fn::If:
              - HasRenderingSuccessType
              - renderingSuccess
              - !Ref AWS::NoValue
