{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS CloudFormation Template to create Spot based Compute environmnet, Job queue and Job Definition for EXE environmnet",
    "Parameters": {
        "PONumber": {
            "Description": "PO Number for billing",
            "Type": "String",
            "Default": "7000002358",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "ApplicationID": {
            "Description": "Application ID - Official Application_ID, this is generated by Sysco's CMDB",
            "Type": "String",
            "Default": "APP-001151",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "ApplicationName": {
            "Description": "Application_Name - Common, user-friendly name",
            "Type": "String",
            "Default": "Cloud Pricing",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "Component": {
            "Description": "Component name",
            "Type": "String",
            "Default": "CP Batch",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "Approver": {
            "Description": "Person approving instance funding.  This should be Email address formatted",
            "Type": "String",
            "Default": "villanueva.loi@corp.sysco.com",
            "MinLength": "1",
            "MaxLength": "255"
        },
        "Owner": {
            "Description": "Email address usually Product/ Platform Owner, though team distribution list for technical product/platform team contact",
            "Type": "String",
            "Default": "villanueva.loi@corp.sysco.com",
            "MinLength": "1",
            "MaxLength": "255"
        },
        "SupportEmail": {
            "Description": "Email distribution list for technical product/platform team contact",
            "Type": "String",
            "Default": "000-BT-PricingPlatform@Corp.sysco.com",
            "MinLength": "1",
            "MaxLength": "255"
        },
        "ProjectID": {
            "Description": "Project_ID - BT Project ID for this workload",
            "Type": "String",
            "Default": "BT.001176",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "2WTAGGER": {
            "Description": "Used by 2nd Watch Managed Services in shared accounts to determine if a resource is supported",
            "Type": "String",
            "Default": "team_managed",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedValues": [
                "team_managed",
                "adlm_managed",
                "2w_managed"
            ],
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "Platform": {
            "Description": "Platform",
            "Type": "String",
            "Default": "Cloud Pricing V4"
        },
        "Environment": {
            "Description": "Name of logical build environment designated for service.",
            "Type": "String",
            "Default": "EXE",
            "AllowedValues": [
                "DEV",
                "QA",
                "STG",
                "Production",
                "Non-Production"
            ],
            "ConstraintDescription": "Must be a valid environment."
        },
        "EnvironmentShort": {
            "Description": "Environment for application",
            "Type": "String",
            "Default": "EXE",
            "AllowedValues": [
                "DEV",
                "QA",
                "STG",
                "EXE",
                "PROD"
            ],
            "ConstraintDescription": "Must be a valid environment."
        },
        "PvtSNa": {
            "Description": "Private PRCP-NP Confidential Subnet 1 in us-east-1a CIDR: 10.133.103.0/24",
            "Type": "String",
            "Default": "subnet-0186b43162a344d9a"
        },
        "PvtSNb": {
            "Description": "Private PRCP-NP Confidential Subnet 2 in us-east-1b CIDR: 10.133.105.0/24",
            "Type": "String",
            "Default": "subnet-0ad1216eb31e15186"
        },
        "PvtSNc": {
            "Description": "Private PRCP-NP Confidential Subnet 3 in us-east-1c CIDR: 10.133.106.0/24",
            "Type": "String",
            "Default": "subnet-0a5d9eea71b9c97c6"
        },
        "VPCID": {
            "Description": "Name of and existing VPC",
            "Type": "String",
            "Default": "vpc-091c7e3e5578d7a4f"
        },
        "SGDNS": {
            "Description": "PRCP-NP-DNS-DNSSG-3J5600OVNNBR",
            "Type": "String",
            "Default": "sg-078061ddab53c5c41"
        },
        "SGRDSMySQL": {
            "Description": "SG-RDSMySQL",
            "Type": "String",
            "Default": "sg-039f822d40c446322"
        },
        "SGWebServices": {
            "Description": "SG-WebServices",
            "Type": "String",
            "Default": "sg-0a56447308e39b902"
        },
        "PemKey": {
            "Description": "Name of and existing EC2 KeyPair to enable SSH access to the instance",
            "Type": "String",
            "Default": "KeyPair-Sysco-CloudPricing-NonProd"
        },
        "CommonAMI": {
            "Description": "CP-Linux-Base-20181112 -> ami-0c2b68244113d8b62",
            "Type": "String",
            "Default": "ami-0c2b68244113d8b62",
            "AllowedPattern": "^ami-[0-9a-fA-F]{17}",
            "ConstraintDescription": "Must be a valid AMI."
        }
    },
    "Resources": {
        "BatchServiceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "Cloud-Pricing-Batch-Service-Role",
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "batch.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole"
                ]
            }
        },
        "IamInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "InstanceProfileName": "Cloud-Pricing-Batch-IAM-Instance-Profile",
                "Roles": [
                    {
                        "Ref": "EcsInstanceRole"
                    }
                ]
            }
        },
        "EcsInstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "CloudPricing-Batch-IAM-Ecs-Instance-Role",
                "AssumeRolePolicyDocument": {
                    "Version": "2008-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ec2.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role",
                    "arn:aws:iam::037295147636:policy/CloudPricing-IAM-RDS-Policy",
                    "arn:aws:iam::037295147636:policy/CloudPricing-IAM-S3-Policy"
                ]
            }
        },
        "AmazonEC2SpotFleetRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "CloudPricing-IAM-EC2-Spot-Fleet-Tagging-Role",
                "AssumeRolePolicyDocument": {
                    "Version": "2008-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "spotfleet.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonEC2SpotFleetTaggingRole"
                ]
            }
        },
        "AWSBatchJobRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "RoleName": "CloudPricing-Batch-IAM-Job-Role",
                "AssumeRolePolicyDocument": {
                    "Version": "2008-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::037295147636:policy/CloudPricing-IAM-RDS-Policy",
                    "arn:aws:iam::037295147636:policy/CloudPricing-IAM-S3-Policy"
                ]
            }
        },
        "JobDefinition": {
            "Type": "AWS::Batch::JobDefinition",
            "Properties": {
                "Type": "container",
                "JobDefinitionName": "CP-Batch-Job-Definition",
                "RetryStrategy": {
                    "Attempts": 2
                },
                "ContainerProperties": {
                    "Image": "sysco/cp-batch",
                    "Vcpus": 1,
                    "Memory": 1000,
                    "Privileged": true,
                    "JobRoleArn": {
                        "Fn::GetAtt": [
                            "AWSBatchJobRole",
                            "Arn"
                        ]
                    }
                }
            },
            "DependsOn": "AWSBatchJobRole"
        },
        "JobQueue": {
            "Type": "AWS::Batch::JobQueue",
            "Properties": {
                "State": "ENABLED",
                "JobQueueName": "CP-Batch-High-Priority-Queue",
                "Priority": 50,
                "ComputeEnvironmentOrder": [
                    {
                        "Order": 1,
                        "ComputeEnvironment": {
                            "Ref": "CPBatchSpotOptimalComputeEnvironment"
                        }
                    }
                ]
            }
        },
        "CPBatchSpotOptimalComputeEnvironment": {
            "Type": "AWS::Batch::ComputeEnvironment",
            "Properties": {
                "Type": "MANAGED",
                "ServiceRole": {
                    "Ref": "BatchServiceRole"
                },
                "ComputeEnvironmentName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-Compute-Environment-",
                            {
                                "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                },
                "ComputeResources": {
                    "Type": "SPOT",
                    "BidPercentage": 100,
                    "MinvCpus": 0,
                    "DesiredvCpus": 4,
                    "MaxvCpus": 64,
                    "InstanceTypes": [
                        "optimal"
                    ],
                    "Ec2KeyPair": {
                        "Ref": "PemKey"
                    },
                    "ImageId": {
                        "Ref": "CommonAMI"
                    },
                    "InstanceRole": {
                        "Ref": "IamInstanceProfile"
                    },
                    "SpotIamFleetRole": {
                        "Ref": "AmazonEC2SpotFleetRole"
                    },
                    "Subnets": [
                        {
                            "Ref": "PvtSNa"
                        }
                    ],
                    "SecurityGroupIds": [
                        {
                            "Ref": "SGDNS"
                        },
                        {
                            "Ref": "SGWebServices"
                        }
                    ],
                    "Tags": [
                        {
                            "Key": "Application_Name",
                            "Value": {
                                "Ref": "ApplicationName"
                            }
                        },
                        {
                            "Key": "Application_ID",
                            "Value": {
                                "Ref": "ApplicationID"
                            }
                        },
                        {
                            "Key": "Owner",
                            "Value": {
                                "Ref": "Owner"
                            }
                        },
                        {
                            "Key": "Approver",
                            "Value": {
                                "Ref": "Approver"
                            }
                        },
                        {
                            "Key": "PO_Number",
                            "Value": {
                                "Ref": "PONumber"
                            }
                        },
                        {
                            "Key": "Environment",
                            "Value": {
                                "Ref": "Environment"
                            }
                        },
                        {
                            "Key": "Project_ID",
                            "Value": {
                                "Ref": "ProjectID"
                            }
                        },
                        {
                            "Key": "Support_Email",
                            "Value": {
                                "Ref": "SupportEmail"
                            }
                        },
                        {
                            "Key": "2WTAGGER",
                            "Value": {
                                "Ref": "2WTAGGER"
                            }
                        },
                        {
                            "Key": "Platform",
                            "Value": {
                                "Ref": "Platform"
                            }
                        },
                        {
                            "Key": "Component",
                            "Value": {
                                "Ref": "Component"
                            }
                        }
                    ]
                },
                "State": "ENABLED"
            }
        }
    }
}