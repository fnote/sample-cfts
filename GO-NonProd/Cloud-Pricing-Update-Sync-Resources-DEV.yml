AWSTemplateFormatVersion: 2010-09-09
Description: This is the stack for CP Update Sync resources
Parameters:
  Environment:
    Description: Environment for application
    Type: String
    Default: Execution
    AllowedValues:
      - Development
      - Execution
      - Quality
      - Staging
      - Tuning
      - Production
    ConstraintDescription: Must be a valid environment
  PONumber:
    Description: PO Number for billing
    Type: String
    Default: 7000002358
  ApplicationID:
    Description: Application ID - Official Application_ID, this is generated by Sysco's CMDB
    Type: String
    Default: APP-001151
  ApplicationName:
    Description: Application_Name - Common, user-friendly name
    Type: String
    Default: Cloud Pricing
  ApplicationSubName:
    Description: Application_Sub_Name - Common, user-friendly name
    Type: String
    Default: CP Update Sync
  Component:
    Description: Component name
    Type: String
    Default: Pricing service
  Owner:
    Description: Email address usually Product/ Platform Owner, though team distribution list for technical product/platform team contact
    Type: String
    Default: krishan.senevirathne@sysco.com
  Approver:
    Description: Person approving instance funding.  This should be Email address formatted
    Type: String
    Default: villanueva.loi@corp.sysco.com
  SupportEmail:
    Description: Email distribution list for technical product/platform team contact
    Type: String
    Default: 000-BT-PricingPlatform@Corp.sysco.com
  ProjectID:
    Description: Project_ID - BT Project ID for this workload
    Type: String
    Default: BT.001176
  2WTAGGER:
    Description: Used by 2nd Watch Managed Services in shared accounts to determine if a resource is supported
    Type: String
    Default: team_managed
  Platform:
    Description: Platform
    Type: String
    Default: CP Pricing Service
  EnvironmentShort:
    Description: Environment for application
    Type: String
    Default: EXE
  ExecutionRole:
    Description: ARN of execution role attached to ECS task.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-Mimix-Purge-Job-Role
  TaskRole:
    Description: ARN of task role attached to ECS task.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-Mimix-Purge-Job-Role
  TriggeringRole:
    Description: ARN of triggering role attached to cloud watch Events.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-Mimix-Purge-Triggering-Role
  BatchServiceRole:
    Description: ARN of triggering role attached to cloud watch Events.
    Type: String
    Default: arn:aws:iam::037295147636:role/Cloud-Pricing-Mimix-Purge-Service-Role
  InstanceRole:
    Description: ARN of role attached to Sync Servers.
    Type: String
    Default: arn:aws:iam::037295147636:instance-profile/Cloud-Pricing-Mimix-Purge-Instance-Profile
  JobDefinitionArn:
    Description: Job Definition Arn
    Type: String
    Default: arn:aws:batch:us-east-1:037295147636:job-definition/CP-Update-Sync-Job-Definition-EXE
  PvtSNa:
    Description: 'Private PRCP-NP Confidential Subnet 1 in us-east-1a CIDR: 10.133.103.0/24'
    Type: String
    Default: subnet-0186b43162a344d9a
  PvtSNb:
    Description: 'Private PRCP-NP Confidential Subnet 2 in us-east-1b CIDR: 10.133.105.0/24'
    Type: String
    Default: subnet-0ad1216eb31e15186
  PvtSNc:
    Description: 'Private PRCP-NP Confidential Subnet 3 in us-east-1c CIDR: 10.133.106.0/24'
    Type: String
    Default: subnet-0a5d9eea71b9c97c6
  VPCID:
    Description: Name of and existing VPC
    Type: String
    Default: vpc-091c7e3e5578d7a4f
  SGDNS:
    Description: PRCP-NP-DNS-DNSSG-3J5600OVNNBR
    Type: String
    Default: sg-078061ddab53c5c41
  SGRDSMySQL:
    Description: SG-RDSMySQL
    Type: String
    Default: sg-039f822d40c446322
  SGWebServices:
    Description: SG-WebServices
    Type: String
    Default: sg-0a56447308e39b902
  RootVolumeSize:
    Description: Root Volume Size
    Type: String
    Default: 150
  PemKey:
    Description: Name of and existing EC2 KeyPair to enable SSH access to the instance
    Type: String
    Default: KeyPair-Sysco-CloudPricing-NonProd
  CommonAMI:
    Description: SYSCOGOLD-TEAMMANAGED-AMZL2_ECS_OPTIMIZED-2021.01.01 -> ami-0f9979854ae60d5b4
    Type: String
    Default: ami-0f9979854ae60d5b4
  ApplicationRole:
    Description: Application Role Tag
    Type: String
    Default: Application Server
  CPUReserved:
    Description: The number of cpu units reserved for the container.
    Type: Number
    Default: '4096'
    MinValue: '256'
    MaxValue: '4096'
  MemoryReserved:
    Description: The soft limit (in MiB) of memory to reserve for the container.
    Type: Number
    Default: '8192'
    MinValue: '256'
    MaxValue: '8192'
  RetentionTime:
    Description: The number of days to retain the log events in the specified log group. Possible values are 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, and 3653.
    Type: Number
    Default: '30'
    MinValue: '1'
    MaxValue: '3653'
  MimixPurgeJobNameSuffix:
    Description: Suffix of the Mimix purge job Name
    Type: String
    Default: Purge-Sync-Job
  MimixPurgeJobQueue:
    Description: ARN of Mimix purge job queue
    Type: String
    Default: arn:aws:batch:us-east-1:037295147636:job-queue/CP-Mimix-Purge-Job-Queue-DEV
    AllowedValues:
      - arn:aws:batch:us-east-1:037295147636:job-queue/CP-Mimix-Purge-Job-Queue-DEV
      - arn:aws:batch:us-east-1:037295147636:job-queue/CP-Mimix-Purge-Job-Queue-EXE
      - arn:aws:batch:us-east-1:037295147636:job-queue/CP-Mimix-Purge-Job-Queue-STG

Resources:
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateData:
        ImageId: !Ref 'CommonAMI'
        BlockDeviceMappings:
          - DeviceName: /dev/xvda
            Ebs:
              VolumeSize: !Ref 'RootVolumeSize'
              VolumeType: io1
              Iops: 2000
              DeleteOnTermination: true
          - DeviceName: /dev/xvdcz
            Ebs:
              VolumeSize: !Ref 'RootVolumeSize'
              VolumeType: io1
              Iops: 2000
              DeleteOnTermination: true
        TagSpecifications:
          - ResourceType: volume
            Tags:
              - Key: Technical:ApplicationName
                Value: !Ref 'ApplicationName'
              - Key: Technical:ApplicationID
                Value: !Ref 'ApplicationID'
              - Key: Technical:PlatformOwner
                Value: !Ref 'Owner'
              - Key: Technical:Environment
                Value: !Ref 'Environment'
              - Key: Technical:ApplicationSubName
                Value: !Ref 'ApplicationSubName'
              - Key: Technical:ApplicationRole
                Value: !Ref 'ApplicationRole'
              - Key: Approver
                Value: !Ref 'Approver'
              - Key: PO_Number
                Value: !Ref 'PONumber'
              - Key: Project_ID
                Value: !Ref 'ProjectID'
              - Key: Support_Email
                Value: !Ref 'SupportEmail'
              - Key: 2WTAGGER
                Value: !Ref '2WTAGGER'
              - Key: Platform
                Value: !Ref 'Platform'
              - Key: Name
                Value: !Ref 'ApplicationSubName'
              - Key: Component
                Value: !Ref 'Component'
      LaunchTemplateName:
        Fn::Join:
          - ''
          - - CP-Update-Sync-Launch-Template-
            - Ref: 'EnvironmentShort'

  UpdateSyncComputeEnvironment:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      Type: MANAGED
      ServiceRole:
        Ref: 'BatchServiceRole'
      ComputeEnvironmentName:
        Fn::Join:
          - ''
          - - CP-Update-Sync-EC2-Compute-Environment-2-
            - Ref: 'EnvironmentShort'
      ComputeResources:
        MaxvCpus: 34
        SecurityGroupIds:
          - !Ref 'SGDNS'
          - !Ref 'SGWebServices'
          - !Ref 'SGRDSMySQL'
        Type: EC2
        Subnets:
          - !Ref 'PvtSNa'
          - !Ref 'PvtSNb'
          - !Ref 'PvtSNc'
        MinvCpus: 0
        InstanceRole: !Ref 'InstanceRole'
        InstanceTypes:
          - optimal
        Ec2KeyPair: !Ref 'PemKey'
        DesiredvCpus: 0
        LaunchTemplate:
          LaunchTemplateId: !Ref 'LaunchTemplate'
          Version: $Latest
        Tags:
          Technical:ApplicationName:
            Ref: 'ApplicationName'
          Technical:ApplicationID:
            Ref: 'ApplicationID'
          Technical:PlatformOwner:
            Ref: 'Owner'
          Technical:Environment:
            Ref: 'Environment'
          Technical:ApplicationSubName:
            Ref: 'ApplicationSubName'
          Technical:ApplicationRole:
            Ref: 'ApplicationRole'
          Approver:
            Ref: 'Approver'
          PO_Number:
            Ref: 'PONumber'
          Project_ID:
            Ref: 'ProjectID'
          Support_Email:
            Ref: 'SupportEmail'
          2WTAGGER:
            Ref: '2WTAGGER'
          Platform:
            Ref: 'Platform'
          Name:
            Ref: 'ApplicationSubName'
          Component:
            Ref: 'Component'
      State: ENABLED

  JobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      State: ENABLED
      JobQueueName:
        Fn::Join:
          - ''
          - - CP-Update-Sync-Job-Queue-
            - Ref: 'EnvironmentShort'
      Priority: 50
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment:
            Ref: 'UpdateSyncComputeEnvironment'

  UpdateSyncTrigger001:
    Type: AWS::Events::Rule
    Properties:
      Description: 'Update Sync trigger for 001'
      Name: !Sub 'Update-sync-001-Trigger-${EnvironmentShort}'
      EventPattern: !Sub
        - |-
          {
            "source": [
              "aws.batch"
            ],
            "detail-type": [
              "Batch Job State Change"
            ],
            "detail": {
              "jobQueue": [
                "${mimixPurgeJobQueue}"
              ],
              "jobName": ["${mimixPurgeJobName}"],
              "status": [
                "SUCCEEDED"
              ]
            }
          }
        - {
          mimixPurgeJobName: !Sub '001-${MimixPurgeJobNameSuffix}',
          mimixPurgeJobQueue: !Ref MimixPurgeJobQueue,
          }
      State: ENABLED
      RoleArn: !Ref 'TriggeringRole'
      Targets:
        - Arn: !Ref 'JobQueue'
          Id: EC2
          InputTransformer:
            InputPathsMap:
              'business_unit' : '$.detail.parameters.business_unit'
            InputTemplate: '{"Parameters" : {"business_unit": <business_unit>}}'
          RoleArn: !Ref 'TriggeringRole'
          BatchParameters:
            JobDefinition: !Ref JobDefinitionArn
            JobName: '001-Update-Sync-Job'

  UpdateSyncTrigger002:
    Type: AWS::Events::Rule
    Properties:
      Description: 'Update Sync trigger for 002'
      Name: !Sub 'Update-sync-002-Trigger-${EnvironmentShort}'
      EventPattern: !Sub
        - |-
          {
            "source": [
              "aws.batch"
            ],
            "detail-type": [
              "Batch Job State Change"
            ],
            "detail": {
              "jobQueue": [
                "${mimixPurgeJobQueue}"
              ],
              "jobName": ["${mimixPurgeJobName}"],
              "status": [
                "SUCCEEDED"
              ]
            }
          }
        - {
          mimixPurgeJobName: !Sub '002-${MimixPurgeJobNameSuffix}',
          mimixPurgeJobQueue: !Ref MimixPurgeJobQueue,
          }
      State: ENABLED
      RoleArn: !Ref 'TriggeringRole'
      Targets:
        - Arn: !Ref 'JobQueue'
          Id: EC2
          InputTransformer:
            InputPathsMap:
              'business_unit' : '$.detail.parameters.business_unit'
            InputTemplate: '{"Parameters" : {"business_unit": <business_unit>}}'
          RoleArn: !Ref 'TriggeringRole'
          BatchParameters:
            JobDefinition: !Ref JobDefinitionArn
            JobName: '002-Update-Sync-Job'
