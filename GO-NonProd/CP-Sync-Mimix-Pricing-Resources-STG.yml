AWSTemplateFormatVersion: 2010-09-09
Description: This is the stack for CP Mimix Sync ECS cluster
Parameters:
  VPCID:
    Description: Name of the VPC for CP-NP
    Type: 'AWS::EC2::VPC::Id'
    Default: vpc-091c7e3e5578d7a4f
    ConstraintDescription: Must be a valid VPC.
  PemKey:
    Description: Name of and existing EC2 KeyPair to enable SSH access to the instance
    Type: 'AWS::EC2::KeyPair::KeyName'
    Default: KeyPair-Sysco-CloudPricing-NonProd
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '[\x20-\x7E]*'
    ConstraintDescription: Must contain only ASCII characters.
  ImageId:
    Description: Amazon AMI -> SYSCOGOLD-TEAMMANAGED-AMZL-ECS-OPTIMIZED-2020.09.04
    Type: 'AWS::EC2::Image::Id'
    Default: 'ami-0a0cdd2cc483521d1'
  ApplicationName:
    Description: Name of application
    Type: String
    Default: 'Cloud Pricing'
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '[\x20-\x7E]*'
    ConstraintDescription: Must contain only ASCII characters.
  ApplicationId:
    Description: Application ID
    Type: String
    Default: 'APP-001151'
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '[\x20-\x7E]*'
    ConstraintDescription: Must contain only ASCII characters.
  PONumber:
    Description: PO Number for billing
    Type: String
    Default: '7000002358'
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '[\x20-\x7E]*'
    ConstraintDescription: Must contain only ASCII characters.
  Approver:
    Description: Name of application approver
    Type: String
    Default: villanueva.loi@corp.sysco.com
    MinLength: '1'
    MaxLength: '255'
  Component:
    Description: Component name
    Type: String
    Default: CP-Sync-Mimix-Pricing
  SupportEmail:
    Description: Email distribution list for technical product/platform team contact
    Type: String
    Default: 000-BT-PricingPlatform@Corp.sysco.com
  2WTAGGER:
    Description: Used by 2nd Watch Managed Services in shared accounts to determine if a resource is supported
    Type: String
    Default: team_managed
  Owner:
    Description: Name of application owner
    Type: String
    Default: krishan.senevirathne@sysco.com
    MinLength: '1'
    MaxLength: '255'
  Environment:
    Description: Environment for application
    Type: String
    Default: Tuning
    AllowedValues:
      - Development
      - Execution
      - Quality
      - Tuning
      - Production
      - Non Production
    ConstraintDescription: Must be a valid environment.
  EnvironmentShort:
    Description: Environment for application
    Type: String
    Default: STG
    AllowedValues:
      - DEV
      - EXE
      - QA
      - STG
      - PROD
      - NONPROD
    ConstraintDescription: Must be a valid environment.
  ProjectId:
    Description: Project ID
    Type: String
    Default: 'BT.001176'
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '[\x20-\x7E]*'
    ConstraintDescription: Must contain only ASCII characters.
  CPConfidentialSubnetA:
    Description: 'Private PRCP-NP Confidential Subnet 1 in us-east-1a CIDR: 10.133.103.0/24'
    Type: 'AWS::EC2::Subnet::Id'
    Default: subnet-0186b43162a344d9a
    MinLength: '1'
    MaxLength: '255'
    ConstraintDescription: Must be a valid Private Subnet.
  CPConfidentialSubnetB:
    Description: 'Private PRCP-NP Confidential Subnet 2 in us-east-1b CIDR: 10.133.105.0/24'
    Type: 'AWS::EC2::Subnet::Id'
    Default: subnet-0ad1216eb31e15186
    MinLength: '1'
    MaxLength: '255'
    ConstraintDescription: Must be a valid Private Subnet.
  CPConfidentialSubnetC:
    Description: 'Private PRCP-NP Confidential Subnet 3 in us-east-1c CIDR: 10.133.106.0/24'
    Type: 'AWS::EC2::Subnet::Id'
    Default: subnet-0a5d9eea71b9c97c6
    MinLength: '1'
    MaxLength: '255'
    ConstraintDescription: Must be a valid Private Subnet.
  SGWebServices:
    Description: Security group for webServices
    Type: String
    Default: sg-0a56447308e39b902
  SGDNS:
    Description: PRCP-NP-DNS-DNSSG-3J5600OVNNBR
    Type: String
    Default: sg-078061ddab53c5c41
  SGRDSMySQL:
    Description: SG-RDSMySQL
    Type: String
    Default: sg-039f822d40c446322
  InstanceType:
    Description: Application EC2 instance type
    Type: String
    Default: t3.medium
  RootVolumeSize:
    Description: Size (GB) of root EBS volume for application instance
    Type: Number
    Default: '150'
    MinValue: '10'
    MaxValue: '1024'
  ApplicationRole:
    Description: Application Role Tag
    Type: String
    Default: Application Server
  WorkloadNodesDesiredCapacity:
    Default: '1'
    Description: The desired capacity for the Workload nodes Auto Scaling group
    Type: String
  WorkloadNodesMaxSize:
    Default: '2'
    Description: The maximum size of the Auto Scaling group
    Type: String
  WorkloadNodesMinSize:
    Default: '1'
    Description: The minimum size of the Auto Scaling group
    Type: String
  ExecutionRole:
    Description: ARN of execution role attached to ECS task.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-PricingSync-JobRole
  TaskRole:
    Description: ARN of task role attached to ECS task.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-PricingSync-JobRole
  MimixInstanceRole:
    Description: ARN of role attached to Mimix Purge Sync Servers.
    Type: String
    Default: arn:aws:iam::037295147636:instance-profile/Cloud-Pricing-Mimix-Instance-Profile
  DockerImageArn:
    Description: Docker image of mimix sync processor
    Type: String
    Default: 037295147636.dkr.ecr.us-east-1.amazonaws.com/cp-sync
  CPUReserved:
    Description: The number of cpu units reserved for the container.
    Type: Number
    Default: '2048'
    MinValue: '256'
    MaxValue: '4096'
  MemoryReserved:
    Description: The soft limit (in MiB) of memory to reserve for the container.
    Type: Number
    Default: '3800'
    MinValue: '256'
    MaxValue: '8192'
  RetentionTime:
    Description: The number of days to retain the log events in the specified log group. Possible values are 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, and 3653.
    Type: Number
    Default: '30'
    MinValue: '1'
    MaxValue: '3653'
  DesiredCount:
    Default: '0'
    Description: The minimum size of the Auto Scaling group
    Type: String

Resources:
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-Ecs-Cluster-'
          - !Ref 'EnvironmentShort'

  ECSAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Metadata:
      Description: "Meta info for cfn signaling"
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MaxBatchSize: '1'
        MinInstancesInService: '1'
        PauseTime: PT5M
        WaitOnResourceSignals: 'true'
    Properties:
      AutoScalingGroupName: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-Auto-Scaling-Group-'
          - !Ref 'EnvironmentShort'
      AvailabilityZones:
        - us-east-1a
        - us-east-1b
        - us-east-1c
      VPCZoneIdentifier:
        - !Ref 'CPConfidentialSubnetA'
        - !Ref 'CPConfidentialSubnetB'
        - !Ref 'CPConfidentialSubnetC'
      LaunchConfigurationName: !Ref 'LaunchConfig'
      DesiredCapacity: !Ref 'WorkloadNodesDesiredCapacity'
      MaxSize: !Ref 'WorkloadNodesMaxSize'
      MinSize: !Ref 'WorkloadNodesMinSize'
      HealthCheckType: EC2
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'CP-Sync-Mimix-Pricing-Auto-Scaling-Server-'
              - !Ref 'EnvironmentShort'
          PropagateAtLaunch: 'true'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
          PropagateAtLaunch: 'true'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
          PropagateAtLaunch: 'true'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
          PropagateAtLaunch: 'true'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
          PropagateAtLaunch: 'true'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
          PropagateAtLaunch: 'true'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
          PropagateAtLaunch: 'true'
        - Key: Approver
          Value: !Ref 'Approver'
          PropagateAtLaunch: 'true'
        - Key: PO_Number
          Value: !Ref 'PONumber'
          PropagateAtLaunch: 'true'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
          PropagateAtLaunch: 'true'
    DependsOn: ECSCluster

  LaunchConfig:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      ImageId: !Ref 'ImageId'
      AssociatePublicIpAddress: false
      InstanceType: !Ref 'InstanceType'
      KeyName: !Ref 'PemKey'
      SecurityGroups:
        - !Ref 'SGWebServices'
        - !Ref 'SGRDSMySQL'
        - !Ref 'SGDNS'
      IamInstanceProfile: !Ref 'MimixInstanceRole'
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: !Ref 'RootVolumeSize'
            VolumeType: gp2
      UserData: !Base64
        Fn::Join:
          - ''
          - - "#!/bin/bash\n"
            - "sudo yum install -y ecs-init\n"
            - "echo ECS_CLUSTER="
            - !Ref 'ECSCluster'
            - " >> /etc/ecs/ecs.config\n"
            - "sudo service docker start\n"
            - "sudo start ecs\n"
            - '/opt/aws/bin/cfn-init -v '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource ECSAutoScalingGroup '
            - '         --region '
            - !Ref 'AWS::Region'
            - |+

            - |
            - '/opt/aws/bin/cfn-signal -e $? '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource ECSAutoScalingGroup '
            - '         --region '
            - !Ref 'AWS::Region'
            - |+
  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Join
        - ''
        - - '/aws/ecs/CP-Sync-Mimix-Pricing-Task'
          - !Ref 'EnvironmentShort'
      RetentionInDays: !Ref 'RetentionTime'

  ServerOneTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S1-Task-Definition-'
          - !Ref 'EnvironmentShort'
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          Cpu: !Ref 'CPUReserved'
          MemoryReservation: !Ref 'MemoryReserved'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/CUSTOMER_PRICING
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_ONE
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: 'Pricing-Alerts-STG'
            - Name: 'TO_ADDRESSES'
              Value: 'amoda.dissanayake@sysco.com,chamin.wickramarathna@sysco.com,gayan.herath@sysco.com,asanka.indunil@corp.sysco.com,gothami.karunarathna@syscolabs.com'

  ServerTwoTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S2-Task-Definition-'
          - !Ref 'EnvironmentShort'
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          Cpu: !Ref 'CPUReserved'
          MemoryReservation: !Ref 'MemoryReserved'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/CUSTOMER_PRICING
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_TWO
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: 'Pricing-Alerts-STG'
            - Name: 'TO_ADDRESSES'
              Value: 'amoda.dissanayake@sysco.com,chamin.wickramarathna@sysco.com,gayan.herath@sysco.com,asanka.indunil@corp.sysco.com,gothami.karunarathna@syscolabs.com'

  ServerThreeTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S3-Task-Definition-'
          - !Ref 'EnvironmentShort'
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          Cpu: !Ref 'CPUReserved'
          MemoryReservation: !Ref 'MemoryReserved'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/CUSTOMER_PRICING
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_THREE
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: 'Pricing-Alerts-STG'
            - Name: 'TO_ADDRESSES'
              Value: 'amoda.dissanayake@sysco.com,chamin.wickramarathna@sysco.com,gayan.herath@sysco.com,asanka.indunil@corp.sysco.com,gothami.karunarathna@syscolabs.com'

  ServerFourTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S4-Task-Definition-'
          - !Ref 'EnvironmentShort'
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          Cpu: !Ref 'CPUReserved'
          MemoryReservation: !Ref 'MemoryReserved'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/CUSTOMER_PRICING
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_FOUR
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: 'Pricing-Alerts-STG'
            - Name: 'TO_ADDRESSES'
              Value: 'amoda.dissanayake@sysco.com,chamin.wickramarathna@sysco.com,gayan.herath@sysco.com,asanka.indunil@corp.sysco.com,gothami.karunarathna@syscolabs.com'

  ServerFiveTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S5-Task-Definition-'
          - !Ref 'EnvironmentShort'
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          Cpu: !Ref 'CPUReserved'
          MemoryReservation: !Ref 'MemoryReserved'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/CUSTOMER_PRICING
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_FIVE
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: 'Pricing-Alerts-STG'
            - Name: 'TO_ADDRESSES'
              Value: 'amoda.dissanayake@sysco.com,chamin.wickramarathna@sysco.com,gayan.herath@sysco.com,asanka.indunil@corp.sysco.com,gothami.karunarathna@syscolabs.com'

  ServerSixTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S6-Task-Definition-'
          - !Ref 'EnvironmentShort'
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          Cpu: !Ref 'CPUReserved'
          MemoryReservation: !Ref 'MemoryReserved'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/CUSTOMER_PRICING
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_SIX
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: 'Pricing-Alerts-STG'
            - Name: 'TO_ADDRESSES'
              Value: 'amoda.dissanayake@sysco.com,chamin.wickramarathna@sysco.com,gayan.herath@sysco.com,asanka.indunil@corp.sysco.com,gothami.karunarathna@syscolabs.com'

  ServerSevenTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S7-Task-Definition-'
          - !Ref 'EnvironmentShort'
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          Cpu: !Ref 'CPUReserved'
          MemoryReservation: !Ref 'MemoryReserved'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/CUSTOMER_PRICING
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_SEVEN
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: 'Pricing-Alerts-STG'
            - Name: 'TO_ADDRESSES'
              Value: 'amoda.dissanayake@sysco.com,chamin.wickramarathna@sysco.com,gayan.herath@sysco.com,asanka.indunil@corp.sysco.com,gothami.karunarathna@syscolabs.com'

  ServerEightTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S8-Task-Definition-'
          - !Ref 'EnvironmentShort'
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          Cpu: !Ref 'CPUReserved'
          MemoryReservation: !Ref 'MemoryReserved'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/CUSTOMER_PRICING
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_EIGHT
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: 'Pricing-Alerts-STG'
            - Name: 'TO_ADDRESSES'
              Value: 'amoda.dissanayake@sysco.com,chamin.wickramarathna@sysco.com,gayan.herath@sysco.com,asanka.indunil@corp.sysco.com,gothami.karunarathna@syscolabs.com'

  ServerNineTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S9-Task-Definition-'
          - !Ref 'EnvironmentShort'
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          Cpu: !Ref 'CPUReserved'
          MemoryReservation: !Ref 'MemoryReserved'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/CUSTOMER_PRICING
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_NINE
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: 'Pricing-Alerts-STG'
            - Name: 'TO_ADDRESSES'
              Value: 'amoda.dissanayake@sysco.com,chamin.wickramarathna@sysco.com,gayan.herath@sysco.com,asanka.indunil@corp.sysco.com,gothami.karunarathna@syscolabs.com'

  ServerTenTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S10-Task-Definition-'
          - !Ref 'EnvironmentShort'
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          Cpu: !Ref 'CPUReserved'
          MemoryReservation: !Ref 'MemoryReserved'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/CUSTOMER_PRICING
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_TEN
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: 'Pricing-Alerts-STG'
            - Name: 'TO_ADDRESSES'
              Value: 'amoda.dissanayake@sysco.com,chamin.wickramarathna@sysco.com,gayan.herath@sysco.com,asanka.indunil@corp.sysco.com,gothami.karunarathna@syscolabs.com'

  ServerOneEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S1-Ecs-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      TaskDefinition: !Ref 'ServerOneTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'

  ServerTwoEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S2-Ecs-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      TaskDefinition: !Ref 'ServerTwoTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'

  ServerThreeEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S3-Ecs-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      TaskDefinition: !Ref 'ServerThreeTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'

  ServerFourEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S4-Ecs-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      TaskDefinition: !Ref 'ServerFourTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'

  ServerFiveEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S5-Ecs-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      TaskDefinition: !Ref 'ServerFiveTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'

  ServerSixEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S6-Ecs-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      TaskDefinition: !Ref 'ServerSixTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'

  ServerSevenEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S7-Ecs-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      TaskDefinition: !Ref 'ServerSevenTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'

  ServerEightEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S8-Ecs-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      TaskDefinition: !Ref 'ServerEightTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'

  ServerNineEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S9-Ecs-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      TaskDefinition: !Ref 'ServerNineTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'

  ServerTenEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S10-Ecs-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: EC2
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      TaskDefinition: !Ref 'ServerTenTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Ref 'Environment'
        - Key: Technical:ApplicationSubName
          Value: !Ref 'Component'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'


Outputs:
  ClusterARN:
    Description: The ECS Cluster ARN
    Value: !GetAtt ECSCluster.Arn

#role, scale policy mapping, non-prod version
