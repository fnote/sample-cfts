{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "AWS CloudFormation Template to create EC2 based Compute environmnet, Job queue and Job Definition for DEV environment",
    "Parameters": {
        "PONumber": {
            "Description": "PO Number for billing",
            "Type": "String",
            "Default": "7000002358",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "ApplicationID": {
            "Description": "Application ID - Official Application_ID, this is generated by Sysco's CMDB",
            "Type": "String",
            "Default": "APP-001151",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "ApplicationName": {
            "Description": "Application_Name - Common, user-friendly name",
            "Type": "String",
            "Default": "Cloud Pricing",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "Component": {
            "Description": "Component name",
            "Type": "String",
            "Default": "CP Batch",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "Approver": {
            "Description": "Person approving instance funding.  This should be Email address formatted",
            "Type": "String",
            "Default": "villanueva.loi@corp.sysco.com",
            "MinLength": "1",
            "MaxLength": "255"
        },
        "Owner": {
            "Description": "Email address usually Product/ Platform Owner, though team distribution list for technical product/platform team contact",
            "Type": "String",
            "Default": "krishan.senevirathne@sysco.com",
            "MinLength": "1",
            "MaxLength": "255"
        },
        "SupportEmail": {
            "Description": "Email distribution list for technical product/platform team contact",
            "Type": "String",
            "Default": "000-BT-PricingPlatform@Corp.sysco.com",
            "MinLength": "1",
            "MaxLength": "255"
        },
        "ProjectID": {
            "Description": "Project_ID - BT Project ID for this workload",
            "Type": "String",
            "Default": "BT.001176",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedPattern": "[\\x20-\\x7E]*",
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "2WTAGGER": {
            "Description": "Used by 2nd Watch Managed Services in shared accounts to determine if a resource is supported",
            "Type": "String",
            "Default": "team_managed",
            "MinLength": "1",
            "MaxLength": "255",
            "AllowedValues": [
                "team_managed",
                "adlm_managed",
                "2w_managed"
            ],
            "ConstraintDescription": "Must contain only ASCII characters."
        },
        "Platform": {
            "Description": "Platform",
            "Type": "String",
            "Default": "Cloud Pricing V4"
        },
        "ApplicationRole": {
            "Description": "The type of application stack",
            "Type": "String",
            "Default": "Batch Compute Environment"
        },
        "Environment": {
            "Description": "Name of logical build environment designated for service.",
            "Type": "String",
            "Default": "Development",
            "AllowedValues": [
                "Development",
                "Quality",
                "Staging",
                "Tuning",
                "Execution",
                "Production"
            ],
            "ConstraintDescription": "Must be a valid environment."
        },
        "EnvironmentShort": {
            "Description": "Environment for application",
            "Type": "String",
            "Default": "DEV",
            "AllowedValues": [
                "DEV",
                "QA",
                "STG",
                "EXE",
                "PROD"
            ],
            "ConstraintDescription": "Must be a valid environment."
        },
        "PvtSNa": {
            "Description": "Private PRCP-NP Confidential Subnet 1 in us-east-1a CIDR: 10.133.103.0/24",
            "Type": "String",
            "Default": "subnet-0186b43162a344d9a"
        },
        "PvtSNb": {
            "Description": "Private PRCP-NP Confidential Subnet 2 in us-east-1b CIDR: 10.133.105.0/24",
            "Type": "String",
            "Default": "subnet-0ad1216eb31e15186"
        },
        "PvtSNc": {
            "Description": "Private PRCP-NP Confidential Subnet 3 in us-east-1c CIDR: 10.133.106.0/24",
            "Type": "String",
            "Default": "subnet-0a5d9eea71b9c97c6"
        },
        "VPCID": {
            "Description": "Name of and existing VPC",
            "Type": "String",
            "Default": "vpc-091c7e3e5578d7a4f"
        },
        "SGDNS": {
            "Description": "PRCP-NP-DNS-DNSSG-3J5600OVNNBR",
            "Type": "String",
            "Default": "sg-078061ddab53c5c41"
        },
        "SGRDSMySQL": {
            "Description": "SG-RDSMySQL",
            "Type": "String",
            "Default": "sg-039f822d40c446322"
        },
        "SGWebServices": {
            "Description": "SG-WebServices",
            "Type": "String",
            "Default": "sg-0a56447308e39b902"
        },
        "PemKey": {
            "Description": "Name of and existing EC2 KeyPair to enable SSH access to the instance",
            "Type": "String",
            "Default": "KeyPair-Sysco-CloudPricing-NonProd"
        },
        "CommonAMI": {
            "Description": "CP-Linux-ECS-Base-20190712 -> ami-029b4991ba32498b2",
            "Type": "String",
            "Default": "ami-00e06e7775c26730e",
            "AllowedPattern": "^ami-[0-9a-fA-F]{17}",
            "ConstraintDescription": "Must be a valid AMI."
        },
        "BatchServiceRole" : {
            "Type" : "String",
            "Description" : "Cloud-Pricing-Batch-Service-Role",
            "Default": "arn:aws:iam::037295147636:role/Cloud-Pricing-Batch-Service-Role"
        },
        "AWSBatchJobRole" : {
            "Type" :"String",
            "Description" : "IAM role for batch job",
            "Default": "arn:aws:iam::037295147636:role/CloudPricing-Batch-IAM-Job-Role"
        },
        "IamInstanceProfile" : {
            "Type" :"String",
            "Description" : "Cloud-Pricing-Batch-IAM-Instance-Profile",
            "Default": "Cloud-Pricing-Batch-IAM-Instance-Profile"
        },
        "EcsInstanceRole" : {
            "Type" :"String",
            "Description" : "CloudPricing-Batch-IAM-ECS-Instance-Role",
            "Default": "arn:aws:iam::037295147636:role/CloudPricing-Batch-IAM-Ecs-Instance-Role"
        },
        "AmazonEC2SpotFleetRole" : {
            "Type" :"String",
            "Description" : "CloudPricing-IAM-EC2-Spot-Fleet-Tagging-Role",
            "Default": "arn:aws:iam::037295147636:role/CloudPricing-IAM-EC2-Spot-Fleet-Tagging-Role"
        }
    },
    "Resources": {

        "JobDefinition": {
            "Type": "AWS::Batch::JobDefinition",
            "Properties": {
                "Type": "container",
                "JobDefinitionName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-Job-Definition-",
                            {
                              "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                },
                "RetryStrategy": {
                    "Attempts": 2
                },
                "Timeout": {
                    "AttemptDurationSeconds" : 10800
                },
                "ContainerProperties": {
                    "Image": "037295147636.dkr.ecr.us-east-1.amazonaws.com/cp-batch-dev:5050ecf7-0d7b-4f63-9073-fcf37908ecf5",
                    "Vcpus": 4,
                    "Memory": 8000,
                    "Privileged": true,
                    "JobRoleArn": "arn:aws:iam::037295147636:role/CloudPricing-Batch-IAM-Job-Role",
                    "Environment": [
                        {
                            "Name": "SERVER_ENVIRONMENT_VARIABLE",
                            "Value": {
                                "Ref": "EnvironmentShort"
                            }
                        }
                    ]
                }
            }
        },
        "LaunchTemplate": {
            "Type" : "AWS::EC2::LaunchTemplate",
            "Properties" : {
                "LaunchTemplateData" : {
                    "ImageId":
                    {
                        "Ref": "CommonAMI"
                    },
                    "IamInstanceProfile" : {
                        "Arn" : "arn:aws:iam::037295147636:instance-profile/Cloud-Pricing-Batch-IAM-Instance-Profile",
                        "Name" : "Cloud-Pricing-Batch-IAM-Instance-Profile"
                    },
                    "BlockDeviceMappings": [
                        {
                            "Ebs": {
                                "Encrypted": false,
                                "DeleteOnTermination": true,
                                "VolumeSize": 75,
                                "VolumeType": "io1",
                                "Iops": 2000
                            },
                            "DeviceName": "/dev/xvda"
                        },
                        {
                            "Ebs": {
                                "Encrypted": false,
                                "DeleteOnTermination": true,
                                "VolumeSize": 75,
                                "VolumeType": "io1",
                                "Iops": 2000
                            },
                            "DeviceName": "/dev/xvdcz"
                        }
                    ],
                    "TagSpecifications": [
                        {
                            "ResourceType": "instance",
                            "Tags": [
                                {
                                    "Key": "Project_ID",
                                    "Value": "BT.001176"
                                },
                                {
                                    "Key": "Technical:ApplicationID",
                                    "Value": "APP-001151"
                                },
                                {
                                    "Key": "2WTAGGER",
                                    "Value": "team_managed"
                                },
                                {
                                    "Key": "Technical:ApplicationRole",
                                    "Value": "Application Server"
                                },
                                {
                                    "Key": "Support_Email",
                                    "Value": "000-BT-PricingPlatform@Corp.sysco.com"
                                },
                                {
                                    "Key": "Technical:PlatformOwner",
                                    "Value": "krishan.senevirathne@sysco.com"
                                },
                                {
                                    "Key": "Name",
                                    "Value": "CP Batch"
                                },
                                {
                                    "Key": "Platform",
                                    "Value": "Cloud Pricing V4"
                                },
                                {
                                    "Key": "Technical:ApplicationSubName",
                                    "Value": "CP Batch"
                                },
                                {
                                    "Key": "Automation:CloudCustodian:LaunchedBy",
                                    "Value": "AutoScaling"
                                }
                            ]
                        }
                    ]
                },
                "LaunchTemplateName": {
                    "Fn::Join": [
                        "",
                        [
                            "LT-CP-Batch-Service-",
                            {
                                "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                }
            }
        },
        "CPBatchSpotOptimalComputeEnvironment": {
            "Type": "AWS::Batch::ComputeEnvironment",
            "Properties": {
                "Type": "MANAGED",
                "ServiceRole": {
                    "Ref": "BatchServiceRole"
                },
                "ComputeEnvironmentName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-Compute-Environment-",
                            {
                                "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                },
                "ComputeResources": {
                    "Type": "EC2",
                    "MinvCpus": 0,
                    "DesiredvCpus": 4,
                    "MaxvCpus": 200,
                    "InstanceTypes": [
                        "optimal"
                    ],
                    "Ec2KeyPair": {
                        "Ref": "PemKey"
                    },
                    "LaunchTemplate": {
                        "LaunchTemplateId": { "Ref": "LaunchTemplate" }
                    },
                    "InstanceRole": {
                        "Ref": "IamInstanceProfile"
                    },
                    "SpotIamFleetRole": {
                        "Ref": "AmazonEC2SpotFleetRole"
                    },
                    "Subnets": [
                        {
                            "Ref": "PvtSNa"
                        }
                    ],
                    "SecurityGroupIds": [
                        {
                            "Ref": "SGDNS"
                        },
                        {
                            "Ref": "SGWebServices"
                        }
                    ],
                    "Tags":
                    {
                        "Technical:ApplicationName": {
                            "Ref": "ApplicationName"
                        }
                    ,

                        "Technical:ApplicationID": {
                            "Ref": "ApplicationID"
                        }
                    ,

                        "Technical:PlatformOwner": {
                            "Ref": "Owner"
                        }
                    ,

                        "Technical:Environment": {
                            "Ref": "Environment"
                        }
                    ,

                        "Technical:ApplicationSubName": {
                            "Ref": "Component"
                        }
                    ,
                        "Technical:ApplicationRole": {
                            "Ref": "ApplicationRole"
                        }
                    ,
                        "Name": {
                            "Ref": "Component"
                        }
                    ,
                        "Approver": {
                            "Ref": "Approver"
                        }
                    ,

                        "PO_Number": {
                            "Ref": "PONumber"
                        }
                    ,

                        "Project_ID": {
                            "Ref": "ProjectID"
                        }
                    ,

                        "Support_Email": {
                            "Ref": "SupportEmail"
                        }
                    ,

                        "2WTAGGER": {
                            "Ref": "2WTAGGER"
                        }
                    ,

                        "Platform": {
                            "Ref": "Platform"
                        }
                    }
                },
                "State": "ENABLED"
            }
        },
        "JobQueueHigh": {
            "Type": "AWS::Batch::JobQueue",
            "Properties":
            {
                "State": "ENABLED",
                "JobQueueName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-P75-Priority-Queue-",
                            {
                              "Ref": "EnvironmentShort"
                            }
                        ]
                      ]
                },
                "Priority": 75,
                "ComputeEnvironmentOrder": [
                    {
                        "Order": 1,
                        "ComputeEnvironment": {
                            "Ref": "CPBatchSpotOptimalComputeEnvironment"
                        }
                    }
                ]
            }

        },
        "JobQueueMedium": {
            "Type": "AWS::Batch::JobQueue",
            "Properties":
            {
                "State": "ENABLED",
                "JobQueueName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-P50-Priority-Queue-",
                            {
                                "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                },
                "Priority": 50,
                "ComputeEnvironmentOrder": [
                    {
                        "Order": 1,
                        "ComputeEnvironment": {
                            "Ref": "CPBatchSpotOptimalComputeEnvironment"
                        }
                    }
                ]
            }
        },
        "JobQueueLow": {
            "Type": "AWS::Batch::JobQueue",
            "Properties": {
                "State": "ENABLED",
                "JobQueueName": {
                    "Fn::Join": [
                        "",
                        [
                            "CP-Batch-P25-Priority-Queue-",
                            {
                                "Ref": "EnvironmentShort"
                            }
                        ]
                    ]
                },
                "Priority": 25,
                "ComputeEnvironmentOrder": [
                    {
                        "Order": 1,
                        "ComputeEnvironment": {
                            "Ref": "CPBatchSpotOptimalComputeEnvironment"
                        }
                    }
                ]
            }
        }
    }
}