AWSTemplateFormatVersion: '2010-09-09'
Description: Reference Price Data Store
Mappings:
  EnvMap:
    DEV:
      val: dev
    QA:
      val: qa
    STG:
      val: stg
    EXE:
      val: exe
    TST:
      val: tst
    PROD:
      val: prod
Parameters:
  PartitionedPZS3:
    Description: This bucket will be used to store partitioned Price zone data
    Type: String
    Default: cp-ref-etl-output-bucket
  PONumber:
    Description: PO Number for billing
    Type: String
    Default: '7000002358'
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: "[\\x20-\\x7E]*"
    ConstraintDescription: Must contain only ASCII characters.
  SGRDSMySQL:
    Description: SG-RDSMySQL
    Type: String
    Default: sg-039f822d40c446322
  snDB:
    Description: Subnets available for the RDS DB Instance
    Type: String
    Default: rds-subnet-group
  ApplicationID:
    Description: Application ID - Official Application_ID, this is generated by Sysco's
      CMDB
    Type: String
    Default: APP-001151
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: "[\\x20-\\x7E]*"
    ConstraintDescription: Must contain only ASCII characters.
  ApplicationName:
    Description: Application_Name - Common, user-friendly name
    Type: String
    Default: Cloud Pricing
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: "[\\x20-\\x7E]*"
    ConstraintDescription: Must contain only ASCII characters.
  Approver:
    Description: Person approving instance funding.  This should be Email address
      formatted
    Type: String
    Default: villanueva.loi@corp.sysco.com
    MinLength: '1'
    MaxLength: '255'
  Owner:
    Description: Email address usually Product/ Platform Owner, though team distribution
      list for technical product/platform team contact
    Type: String
    Default: krishan.senevirathne@sysco.com
    MinLength: '1'
    MaxLength: '255'
  SupportEmail:
    Description: Email distribution list for technical product/platform team contact
    Type: String
    Default: 000-BT-PricingPlatform@Corp.sysco.com
    MinLength: '1'
    MaxLength: '255'
  ProjectID:
    Description: Project_ID - BT Project ID for this workload
    Type: String
    Default: BT.001176
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: "[\\x20-\\x7E]*"
    ConstraintDescription: Must contain only ASCII characters.
  2WTAGGER:
    Description: Used by 2nd Watch Managed Services in shared accounts to determine
      if a resource is supported
    Type: String
    Default: team-managed
    MinLength: '1'
    MaxLength: '255'
    AllowedValues:
      - team-managed
      - adlm-managed
      - 2w-managed
    ConstraintDescription: Must contain only ASCII characters.
  Platform:
    Description: Platform
    Type: String
    Default: Cloud Pricing V4
  Environment:
    Description: Name of logical build environment designated for service.
    Type: String
    Default: Development
    AllowedValues:
      - Development
      - Quality
      - Staging
      - Tuning
      - Execution
      - Production
    ConstraintDescription: Must be a valid environment.
  EnvironmentShort:
    Description: Environment for application
    Type: String
    Default: DEV
    AllowedValues:
      - DEV
      - QA
      - STG
      - EXE
      - TST
      - PROD
    ConstraintDescription: Must be a valid environment.
  DBInstanceType:
    Description: DB Instance class
    Type: String
    Default: db.r5.large
    AllowedValues:
      - db.r5.large
      - db.r5.xlarge
      - db.r5.2xlarge
      - db.r5.4xlarge
    ConstraintDescription: Must be a valid environment.
  ClusterName:
    Description: Cluster Name
    Type: String
    Default: cp-ref-price-db-cluster-01
    AllowedValues:
      - cp-ref-price-db-cluster-01
      - cp-ref-price-db-cluster-02
      - cp-ref-price-db-cluster-03
      - cp-ref-price-db-cluster-04
    ConstraintDescription: Must be a cluster name
  PermissionBoundary:
    Description: Maximum permission boundary
    Type: String
    Default: PermissionBoundary-DevOps

Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Join ['-', [!Ref PartitionedPZS3, !FindInMap [EnvMap, !Ref EnvironmentShort, val]]]
      Tags:
        - Key: Name
          Value: !Join ['', [!Ref PartitionedPZS3, !Ref EnvironmentShort]]
        - Key: Technical:ApplicationName
          Value: !Ref ApplicationName
        - Key: Technical:ApplicationID
          Value: !Ref ApplicationID
        - Key: Technical:PlatformOwner
          Value: !Ref Owner
        - Key: Technical:Environment
          Value: !Ref Environment
        - Key: Support_Email
          Value: !Ref SupportEmail
        - Key: Approver
          Value: !Ref Approver
        - Key: PO_Number
          Value: !Ref PONumber
        - Key: Project_ID
          Value: !Ref ProjectID
        - Key: 2WTAGGER
          Value: team_managed
        - Key: Platform
          Value: !Ref Platform
        - Key: Component
          Value: S3 bucket

  ReferencePriceETLS3ReadAccessPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      ManagedPolicyName: !Sub 'CP-REF-etl-s3-read-policy-${EnvironmentShort}'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: VisualEditor0
            Effect: Allow
            Action:
              - s3:GetObject
              - s3:ListBucket
              - s3:GetObjectVersion
            Resource: [
                !Join ['', ['arn:aws:s3:::', !Join ['-', [!Ref PartitionedPZS3, !FindInMap [ EnvMap, !Ref EnvironmentShort, val ]]]]],
                !Join ['', ['arn:aws:s3:::', !Join ['-', [!Ref PartitionedPZS3, !FindInMap [ EnvMap, !Ref EnvironmentShort, val ]]], '/*']]
            ]

  ReferencePriceETLS3ReadAccessRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub 'CP-REF-etl-s3-read-access-role-${EnvironmentShort}'
      Description: role to allow etl s3 buckets read access
      PermissionsBoundary: !Sub 'arn:aws:iam::${AWS::AccountId}:policy/${PermissionBoundary}'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - sts:AssumeRole
            Principal:
              Service:
                - rds.amazonaws.com
      Path: "/"
      ManagedPolicyArns: [!Ref ReferencePriceETLS3ReadAccessPolicy]

  CpRefLoadFromS3ParameterGroup:
    Type: AWS::RDS::DBClusterParameterGroup
    Properties:
      Description: Parameter group to enable aurora_load_from_s3_role
      Family: aurora-mysql5.7
      Parameters:
        aurora_load_from_s3_role: !GetAtt ReferencePriceETLS3ReadAccessRole.Arn
      Tags:
        - Key: Name
          Value: !Join ['', ['cp-ref-price-db-parameter-group', !Ref EnvironmentShort]]
        - Key: Technical:ApplicationName
          Value: !Ref ApplicationName
        - Key: Technical:ApplicationID
          Value: !Ref ApplicationID
        - Key: Technical:PlatformOwner
          Value: !Ref Owner
        - Key: Technical:Environment
          Value: !Ref Environment
        - Key: Support_Email
          Value: !Ref SupportEmail
        - Key: Approver
          Value: !Ref Approver
        - Key: PO_Number
          Value: !Ref PONumber
        - Key: Project_ID
          Value: !Ref ProjectID
        - Key: 2WTAGGER
          Value: team_managed
        - Key: Platform
          Value: !Ref Platform
        - Key: Component
          Value: Aurora DB

  CPRefPriceDBCluster:
    Type: AWS::RDS::DBCluster
    DependsOn: CpRefLoadFromS3ParameterGroup
    DeletionPolicy: Snapshot
    Properties:
      AssociatedRoles:
        - RoleArn: !GetAtt ReferencePriceETLS3ReadAccessRole.Arn
      AvailabilityZones:
        - us-east-1a
        - us-east-1c
        - us-east-1b
      DBClusterIdentifier: !Join ['-', [!Ref ClusterName, !FindInMap [EnvMap, !Ref EnvironmentShort, val]]]
      DBClusterParameterGroupName: !Ref CpRefLoadFromS3ParameterGroup
      Engine: aurora-mysql
      EngineMode: provisioned
      EngineVersion: 5.7.mysql_aurora.2.08.1
      MasterUsername: !Join ['', ["{{resolve:ssm:/CP/", !Ref EnvironmentShort, "/DATABASE/REF_PRICE/USERNAME:1}}"]]
      MasterUserPassword: !Join ['', ["{{resolve:ssm-secure:/CP/", !Ref EnvironmentShort, "/DATABASE/REF_PRICE/PASSWORD:1}}"]]
      Port: '3306'
      VpcSecurityGroupIds: [!Ref SGRDSMySQL]
      DBSubnetGroupName: !Ref snDB
      Tags:
        - Key: Name
          Value: !Join ['', [!Ref ClusterName, !Ref EnvironmentShort]]
        - Key: Technical:ApplicationName
          Value: !Ref ApplicationName
        - Key: Technical:ApplicationID
          Value: !Ref ApplicationID
        - Key: Technical:PlatformOwner
          Value: !Ref Owner
        - Key: Technical:Environment
          Value: !Ref Environment
        - Key: Support_Email
          Value: !Ref SupportEmail
        - Key: Approver
          Value: !Ref Approver
        - Key: PO_Number
          Value: !Ref PONumber
        - Key: Project_ID
          Value: !Ref ProjectID
        - Key: 2WTAGGER
          Value: team_managed
        - Key: Platform
          Value: !Ref Platform
        - Key: Component
          Value: Aurora DB

  DB01Primary01:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub 'cp-ref-price-01-${EnvironmentShort}'
      AllowMajorVersionUpgrade: 'true'
      AutoMinorVersionUpgrade: 'true'
      CopyTagsToSnapshot: 'true'
      DBClusterIdentifier: !Ref CPRefPriceDBCluster
      DBInstanceClass: !Ref DBInstanceType
      CACertificateIdentifier: rds-ca-2019
      Engine: aurora-mysql
      DBSubnetGroupName: !Ref snDB
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Join ['', [!Ref ClusterName, !Ref EnvironmentShort]]
        - Key: Technical:ApplicationName
          Value: !Ref ApplicationName
        - Key: Technical:ApplicationID
          Value: !Ref ApplicationID
        - Key: Technical:PlatformOwner
          Value: !Ref Owner
        - Key: Technical:Environment
          Value: !Ref Environment
        - Key: Support_Email
          Value: !Ref SupportEmail
        - Key: Approver
          Value: !Ref Approver
        - Key: PO_Number
          Value: !Ref PONumber
        - Key: Project_ID
          Value: !Ref ProjectID
        - Key: 2WTAGGER
          Value: team_managed
        - Key: Platform
          Value: !Ref Platform
        - Key: Component
          Value: Aurora DB
  DB01Primary02:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub 'cp-ref-price-02-${EnvironmentShort}'
      AllowMajorVersionUpgrade: 'true'
      AutoMinorVersionUpgrade: 'true'
      CopyTagsToSnapshot: 'true'
      DBClusterIdentifier: !Ref CPRefPriceDBCluster
      DBInstanceClass: !Ref DBInstanceType
      CACertificateIdentifier: rds-ca-2019
      Engine: aurora-mysql
      DBSubnetGroupName: !Ref snDB
      PubliclyAccessible: false
      Tags:
        - Key: Name
          Value: !Join ['', [!Ref ClusterName, !Ref EnvironmentShort]]
        - Key: Technical:ApplicationName
          Value: !Ref ApplicationName
        - Key: Technical:ApplicationID
          Value: !Ref ApplicationID
        - Key: Technical:PlatformOwner
          Value: !Ref Owner
        - Key: Technical:Environment
          Value: !Ref Environment
        - Key: Support_Email
          Value: !Ref SupportEmail
        - Key: Approver
          Value: !Ref Approver
        - Key: PO_Number
          Value: !Ref PONumber
        - Key: Project_ID
          Value: !Ref ProjectID
        - Key: 2WTAGGER
          Value: team_managed
        - Key: Platform
          Value: !Ref Platform
        - Key: Component
          Value: Aurora DB

  AutoScalerTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MinCapacity: 1
      MaxCapacity: 15
      ResourceId: !Sub 'cluster:${CPRefPriceDBCluster}'
      ScalableDimension: rds:cluster:ReadReplicaCount
      ServiceNamespace: rds
      RoleARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/aws-service-role/rds.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_RDSCluster'

  AutoScaler:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      ScalingTargetId: !Ref AutoScalerTarget
      ServiceNamespace: rds
      PolicyName: CPU Auto scale policy
      PolicyType: TargetTrackingScaling
      ScalableDimension: rds:cluster:ReadReplicaCount
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: RDSReaderAverageCPUUtilization
        TargetValue: 40
        ScaleOutCooldown: 300
        ScaleInCooldown: 300
        DisableScaleIn: false

Outputs:
  dbUrl00:
    Description: Endpoint for Cluster
    Value: !Join ['', [!GetAtt CPRefPriceDBCluster.Endpoint.Address]]
  dbUrl01:
    Description: Read Endpoint Cluster
    Value: !Join ['', [!GetAtt CPRefPriceDBCluster.ReadEndpoint.Address]]
