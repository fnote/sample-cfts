AWSTemplateFormatVersion: 2010-09-09
Description: Stack for Outlier Price Range Resources.  
Parameters:
  Environment:
    Description: Environment for application
    Type: String
    Default: EXE
    AllowedValues:
      - DEV
      - EXE
      - QA
      - STG
      - PROD
      - NONPROD
    ConstraintDescription: Must be a valid environment.
  ExecutionRole:
    Description: ARN of execution role attached to ECS task.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-Batch-IAM-Job-Role
  TaskRole:
    Description: ARN of task role attached to ECS task.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-Batch-IAM-Job-Role
  RoleArn:
    Description: ARN of task role attached to cloud watch Events.
    Type: String
    Default: arn:aws:iam::037295147636:role/Princing-Web-Service-Role
  DockerImageArn:
    Description: Docker image of outlier price range
    Type: String
    Default: 037295147636.dkr.ecr.us-east-1.amazonaws.com/cp-outlier-price-range
  CPUForTask:
    Description: The number of cpu units reserved for the task.
    Type: Number
    Default: '1024'
    MinValue: '256'
    MaxValue: '4096'
  CPUForContainer:
    Description: The number of cpu units reserved for the container.
    Type: Number
    Default: '512'
    MinValue: '256'
    MaxValue: '4096'
  MemoryForTask:
    Description: The soft limit (in MiB) of memory to reserve for the task.
    Type: Number
    Default: '2048'
    MinValue: '256'
    MaxValue: '8192'
  MemoryForContainer:
    Description: The soft limit (in MiB) of memory to reserve for the container.
    Type: Number
    Default: '1024'
    MinValue: '256'
    MaxValue: '8192'
  PvtSNa:
    Description: 'Private PRCP-NP Confidential Subnet 1 in us-east-1a CIDR: 10.132.88.0/24'
    Type: String
    Default: subnet-0186b43162a344d9a
  PvtSNb:
    Description: 'Private PRCP-NP Confidential Subnet 2 in us-east-1b CIDR: 10.132.89.0/24'
    Type: String
    Default: subnet-0ad1216eb31e15186
  PvtSNc:
    Description: 'Private PRCP-NP Confidential Subnet 3 in us-east-1c CIDR: 10.132.89.0/24'
    Type: String
    Default: subnet-0a5d9eea71b9c97c6
  VPCID:
    Description: Name of an existing VPC
    Type: String
    Default: vpc-091c7e3e5578d7a4f
  SGECS:
    Description: Security group with ECS Allowed Ports
    Type: String
    Default: sg-0d9f433edb4677f08
  RetentionTime:
    Description: The number of days to retain the log events in the specified log group. Possible values are 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, and 3653.
    Type: Number
    Default: '30'
    MinValue: '1'
    MaxValue: '3653'
  DbURL:
    Description: URL of the database that Glue Connection Catalog should use
    Type: String
    Default: jdbc:mysql://ecomm01dbcluster.cluster-c6xai0tt38eb.us-east-1.rds.amazonaws.com:33060/ECOMMDB_Common01e
  DbUser:
    Description: Username of the database that Glue Connection Catalog should use
    Type: String
    Default: TBA
  DbPassword:
    Description: Password of the database that Glue Connection Catalog should use
    Type: String
    Default: TBA
  SecurityGroupForGlueConnection:
    Description: Security group for glue connection
    Type: String
    Default: sg-06a4893b70fc2f68f
  SubetForGlueConnection:
    Description: Subnet for glue connection
    Type: String
    Default: subnet-0ad1216eb31e15186
  AZForGlueConnection:
    Description: Availability zone for glue connection
    Type: String
    Default: us-east-1b
  OutlierPriceRangeS3Bucket:
    Description: Availability zone for glue connection
    Type: String
    Default: s3://sysco-us-east-1-prcp-nonprod-outlier-price-range
    AllowedValues:
      - s3://sysco-us-east-1-prcp-dev-outlier-price-range
      - s3://sysco-us-east-1-prcp-nonprod-outlier-price-range
      - s3://sysco-us-east-1-prcp-prod-outlier-price-range

Resources:

  ECSCluster:
    Type: 'AWS::ECS::Cluster'
    Properties:
      ClusterName: !Join
        - ''
        - - 'CP-iOPR-Data-Creation-Cluster-'
          - !Ref 'Environment'
    
  DataCreationTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Cpu: !Ref CPUForTask
      ExecutionRoleArn: !Ref ExecutionRole
      TaskRoleArn: !Ref TaskRole
      Family: !Join
        - ''
        - - 'CP-iOPR-Data-Creation-Task-Definition-'
          - !Ref 'Environment'
      Memory: !Ref MemoryForTask
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ContainerDefinitions:
      - Essential: true
        Image: !Ref DockerImageArn
        Name: cp-iopr-data-creation
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref LogGroup
            awslogs-region: !Ref 'AWS::Region'
            awslogs-stream-prefix: ecs/iOPR
        PortMappings:
          - {ContainerPort: 80}
          - {ContainerPort: 5439}
        Environment:
          - Name: SERVER_ENVIRONMENT_VARIABLE
            Value: !Ref Environment
    DependsOn:
    - ECSCluster

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Join
        - ''
        - - '/aws/ecs/CP-iOPR-Data-Creation-'
          - !Ref 'Environment'
      RetentionInDays: !Ref RetentionTime

  ScheduleRule1To5:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for opco 001 - 005"
      Name: !Join
        - ''
        - - 'Price-Range-001-005-'
          - !Ref 'Environment'
      State: DISABLED
      ScheduleExpression: 'cron(30 1 ? * THU *)'
      RoleArn: !Ref RoleArn
      Targets:
        - Arn: !GetAtt
            - ECSCluster
            - Arn
          Id: ScheduledTask
          RoleArn: !Ref RoleArn
          Input: !Sub '{ "containerOverrides": [{"name": "cp-iopr-data-creation", "environment": [{"name": "BUSINESS_UNITS","value": "001, 002, 003, 004, 005"},
          {"name": "BUCKET_NAME","value": "${OutlierPriceRangeS3Bucket}"}]}]}'
          EcsParameters:
            TaskDefinitionArn: !Ref 'DataCreationTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                - !Ref 'SGECS' 
                Subnets:
                - !Ref 'PvtSNa'
                - !Ref 'PvtSNb'
                - !Ref 'PvtSNc'

  ScheduleRule55To57:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for opco 055 - 057"
      Name: !Join
        - ''
        - - 'Price-Range-055-057-'
          - !Ref 'Environment'
      State: DISABLED
      ScheduleExpression: 'cron(45 1 ? * THU *)'
      RoleArn: !Ref RoleArn
      Targets:
        - Arn: !GetAtt
            - ECSCluster
            - Arn
          Id: ScheduledTask
          RoleArn: !Ref RoleArn
          Input: !Sub '{ "containerOverrides": [{"name": "cp-iopr-data-creation", "environment": [{"name": "BUSINESS_UNITS","value": "055, 056, 057"},
          {"name": "BUCKET_NAME","value": "${OutlierPriceRangeS3Bucket}"}]}]}'
          EcsParameters:
            TaskDefinitionArn: !Ref 'DataCreationTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                - !Ref 'SGECS' 
                Subnets:
                - !Ref 'PvtSNa'
                - !Ref 'PvtSNb'
                - !Ref 'PvtSNc'

  ScheduleRule66To68:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for opco 066 - 068"
      Name: !Join
        - ''
        - - 'Price-Range-066-068-'
          - !Ref 'Environment'
      State: ENABLED
      ScheduleExpression: 'cron(31 21 ? * TUE *)'
      RoleArn: !Ref RoleArn
      Targets:
        - Arn: !GetAtt
            - ECSCluster
            - Arn
          Id: ScheduledTask
          RoleArn: !Ref RoleArn
          Input: !Sub '{ "containerOverrides": [{"name": "cp-iopr-data-creation", "environment": [{"name": "BUSINESS_UNITS","value": "066, 067, 068"},
          {"name": "BUCKET_NAME","value": "${OutlierPriceRangeS3Bucket}"}]}]}'
          EcsParameters:
            TaskDefinitionArn: !Ref 'DataCreationTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                - !Ref 'SGECS' 
                Subnets:
                - !Ref 'PvtSNa'
                - !Ref 'PvtSNb'
                - !Ref 'PvtSNc'

  ScheduleRuleWeekly1To10:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for opco 001 - 010"
      Name: !Join
        - ''
        - - 'Price-Range-Weekly-001-010-'
          - !Ref 'Environment'
      State: ENABLED
      ScheduleExpression: 'cron(00 20 ? * TUE *)'
      RoleArn: !Ref RoleArn
      Targets:
        - Arn: !GetAtt
            - ECSCluster
            - Arn
          Id: ScheduledTask
          RoleArn: !Ref RoleArn
          Input: !Sub '{ "containerOverrides": [{"name": "cp-iopr-data-creation", "environment": [{"name": "BUSINESS_UNITS","value": "001, 002, 003, 004, 005, 006, 007, 008, 009, 010"},
          {"name": "BUCKET_NAME","value": "${OutlierPriceRangeS3Bucket}"}]}]}'
          EcsParameters:
            TaskDefinitionArn: !Ref 'DataCreationTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                - !Ref 'SGECS' 
                Subnets:
                - !Ref 'PvtSNa'
                - !Ref 'PvtSNb'
                - !Ref 'PvtSNc'

  ScheduleRuleWeekly11To22:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for opco 011 - 022"
      Name: !Join
        - ''
        - - 'Price-Range-Weekly-011-022-'
          - !Ref 'Environment'
      State: ENABLED
      ScheduleExpression: 'cron(00 20 ? * TUE *)'
      RoleArn: !Ref RoleArn
      Targets:
        - Arn: !GetAtt
            - ECSCluster
            - Arn
          Id: ScheduledTask
          RoleArn: !Ref RoleArn
          Input: !Sub '{ "containerOverrides": [{"name": "cp-iopr-data-creation", "environment": [{"name": "BUSINESS_UNITS","value": "011, 012, 013, 014, 015, 016, 017, 018, 019, 022"},
          {"name": "BUCKET_NAME","value": "${OutlierPriceRangeS3Bucket}"}]}]}'
          EcsParameters:
            TaskDefinitionArn: !Ref 'DataCreationTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                - !Ref 'SGECS' 
                Subnets:
                - !Ref 'PvtSNa'
                - !Ref 'PvtSNb'
                - !Ref 'PvtSNc'

  ScheduleRuleWeekly23To36:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for opco 023 - 036"
      Name: !Join
        - ''
        - - 'Price-Range-Weekly-023-036-'
          - !Ref 'Environment'
      State: ENABLED
      ScheduleExpression: 'cron(00 20 ? * TUE *)'
      RoleArn: !Ref RoleArn
      Targets:
        - Arn: !GetAtt
            - ECSCluster
            - Arn
          Id: ScheduledTask
          RoleArn: !Ref RoleArn
          Input: !Sub '{ "containerOverrides": [{"name": "cp-iopr-data-creation", "environment": [{"name": "BUSINESS_UNITS","value": "023, 024, 025, 026, 027, 029, 031, 032, 035, 036"},
          {"name": "BUCKET_NAME","value": "${OutlierPriceRangeS3Bucket}"}]}]}'
          EcsParameters:
            TaskDefinitionArn: !Ref 'DataCreationTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                - !Ref 'SGECS' 
                Subnets:
                - !Ref 'PvtSNa'
                - !Ref 'PvtSNb'
                - !Ref 'PvtSNc'

  ScheduleRuleWeekly37To49:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for opco 037 - 049"
      Name: !Join
        - ''
        - - 'Price-Range-Weekly-037-049-'
          - !Ref 'Environment'
      State: ENABLED
      ScheduleExpression: 'cron(00 20 ? * TUE *)'
      RoleArn: !Ref RoleArn
      Targets:
        - Arn: !GetAtt
            - ECSCluster
            - Arn
          Id: ScheduledTask
          RoleArn: !Ref RoleArn
          Input: !Sub '{ "containerOverrides": [{"name": "cp-iopr-data-creation", "environment": [{"name": "BUSINESS_UNITS","value": "037, 038, 039, 040, 043, 045, 046, 047, 048, 049"},
          {"name": "BUCKET_NAME","value": "${OutlierPriceRangeS3Bucket}"}]}]}'
          EcsParameters:
            TaskDefinitionArn: !Ref 'DataCreationTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                - !Ref 'SGECS' 
                Subnets:
                - !Ref 'PvtSNa'
                - !Ref 'PvtSNb'
                - !Ref 'PvtSNc'

  ScheduleRuleWeekly50To60:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for opco 050 - 060"
      Name: !Join
        - ''
        - - 'Price-Range-Weekly-050-060-'
          - !Ref 'Environment'
      State: ENABLED
      ScheduleExpression: 'cron(00 20 ? * TUE *)'
      RoleArn: !Ref RoleArn
      Targets:
        - Arn: !GetAtt
            - ECSCluster
            - Arn
          Id: ScheduledTask
          RoleArn: !Ref RoleArn
          Input: !Sub '{ "containerOverrides": [{"name": "cp-iopr-data-creation", "environment": [{"name": "BUSINESS_UNITS","value": "050, 051, 052, 054, 055, 056, 057, 058, 059, 060"},
          {"name": "BUCKET_NAME","value": "${OutlierPriceRangeS3Bucket}"}]}]}'
          EcsParameters:
            TaskDefinitionArn: !Ref 'DataCreationTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                - !Ref 'SGECS' 
                Subnets:
                - !Ref 'PvtSNa'
                - !Ref 'PvtSNb'
                - !Ref 'PvtSNc'

  ScheduleRuleWeekly61To102:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for opco 061 - 102"
      Name: !Join
        - ''
        - - 'Price-Range-Weekly-061-102-'
          - !Ref 'Environment'
      State: ENABLED
      ScheduleExpression: 'cron(00 20 ? * TUE *)'
      RoleArn: !Ref RoleArn
      Targets:
        - Arn: !GetAtt
            - ECSCluster
            - Arn
          Id: ScheduledTask
          RoleArn: !Ref RoleArn
          Input: !Sub '{ "containerOverrides": [{"name": "cp-iopr-data-creation", "environment": [{"name": "BUSINESS_UNITS","value": "061, 064, 066, 067, 068, 073, 075, 076, 078, 101, 102"},
          {"name": "BUCKET_NAME","value": "${OutlierPriceRangeS3Bucket}"}]}]}'
          EcsParameters:
            TaskDefinitionArn: !Ref 'DataCreationTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                - !Ref 'SGECS' 
                Subnets:
                - !Ref 'PvtSNa'
                - !Ref 'PvtSNb'
                - !Ref 'PvtSNc'

  ScheduleRuleWeekly137To450:
    Type: AWS::Events::Rule
    Properties:
      Description: "Schedule rule for opco 137 - 450"
      Name: !Join
        - ''
        - - 'Price-Range-Weekly-137-450-'
          - !Ref 'Environment'
      State: ENABLED
      ScheduleExpression: 'cron(00 20 ? * TUE *)'
      RoleArn: !Ref RoleArn
      Targets:
        - Arn: !GetAtt
            - ECSCluster
            - Arn
          Id: ScheduledTask
          RoleArn: !Ref RoleArn
          Input: !Sub '{ "containerOverrides": [{"name": "cp-iopr-data-creation", "environment": [{"name": "BUSINESS_UNITS","value": "137, 163, 164, 194, 195, 288, 293, 306, 320, 332, 450"},
          {"name": "BUCKET_NAME","value": "${OutlierPriceRangeS3Bucket}"}]}]}'
          EcsParameters:
            TaskDefinitionArn: !Ref 'DataCreationTaskDefinition'
            LaunchType: FARGATE
            NetworkConfiguration:
              AwsVpcConfiguration:
                AssignPublicIp: DISABLED
                SecurityGroups:
                - !Ref 'SGECS' 
                Subnets:
                - !Ref 'PvtSNa'
                - !Ref 'PvtSNb'
                - !Ref 'PvtSNc'

  EcommDbConnection:
    Type: AWS::Glue::Connection
    Properties:
      CatalogId: !Ref AWS::AccountId
      ConnectionInput:
        Name: "ecomm-common-connection"
        Description: "Ecomm database connection to Common DB"
        ConnectionType: "JDBC"
        ConnectionProperties: {
          "JDBC_CONNECTION_URL": !Ref DbURL,
          "USERNAME": !Ref DbUser,
          "PASSWORD": !Ref DbPassword
        }
        PhysicalConnectionRequirements:
          AvailabilityZone: !Ref 'AZForGlueConnection'
          SecurityGroupIdList:
          - !Ref 'SecurityGroupForGlueConnection'
          SubnetId: !Ref 'SubetForGlueConnection'


  DataPopulationGlueJob:
    Type: "AWS::Glue::Job"
    Properties:
      Description: "Glue job to populate data"
      Name: !Join
        - ''
        - - 'iOPR-Data-Population-'
          - !Ref 'Environment'
      Command:
        Name: pythonshell
        ScriptLocation: "s3://sysco-us-east-1-prcp-nonprod-codebuild/Outlier-Price-Range/glue-job-scripts/loaddata.py"
        PythonVersion: "3"
      MaxCapacity: 0.0625
      Connections:
        Connections:
          - !Ref EcommDbConnection
      DefaultArguments:
        "--extra-py-files": "s3://sysco-us-east-1-prcp-nonprod-codebuild/Outlier-Price-Range/python-libs/PyMySQL-0.9.3-py2.py3-none-any.whl"
      ExecutionProperty:
        MaxConcurrentRuns: 75
      MaxRetries: 0
      NotificationProperty:
        NotifyDelayAfter: 15
      Role: "arn:aws:iam::037295147636:role/OutlierPriceRangeGlueRole"
      Timeout: 30
      


Outputs:
  DataCreationTaskDefinition:
    Description: The Cp Data Creation Task Definition ARN
    Value: !Ref DataCreationTaskDefinition
  ClusterARN:
    Description: The ECS Cluster ARN
    Value: !GetAtt ECSCluster.Arn

