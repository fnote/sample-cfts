AWSTemplateFormatVersion: 2010-09-09
Description: This is the stack for CP Mimix Sync ECS cluster
Parameters:
  ApplicationName:
    Description: Name of application
    Type: String
    Default: 'Cloud Pricing'
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '[\x20-\x7E]*'
    ConstraintDescription: Must contain only ASCII characters.
  ApplicationId:
    Description: Application ID
    Type: String
    Default: 'APP-001151'
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '[\x20-\x7E]*'
    ConstraintDescription: Must contain only ASCII characters.
  PONumber:
    Description: PO Number for billing
    Type: String
    Default: '7000002358'
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '[\x20-\x7E]*'
    ConstraintDescription: Must contain only ASCII characters.
  Approver:
    Description: Name of application approver
    Type: String
    Default: villanueva.loi@corp.sysco.com
    MinLength: '1'
    MaxLength: '255'
  ApplicationSubName:
    Description: Application_Sub_Name - Common, user-friendly name
    Type: String
    Default: CP-Sync-Mimix-Pricing
  Component:
    Description: Component Name
    Type: String
    Default: Pricing service
  SupportEmail:
    Description: Email distribution list for technical product/platform team contact
    Type: String
    Default: 000-BT-PricingPlatform@Corp.sysco.com
  2WTAGGER:
    Description: Used by 2nd Watch Managed Services in shared accounts to determine if a resource is supported
    Type: String
    Default: team_managed
  Platform:
    Description: Platform
    Type: String
    Default: CP Pricing Service
  Owner:
    Description: Name of application owner
    Type: String
    Default: krishan.senevirathne@sysco.com
    MinLength: '1'
    MaxLength: '255'
  Subnets:
    Description: 'Private PRCP-NP Confidential Subnets'
    Type: CommaDelimitedList
    Default: "subnet-0186b43162a344d9a,subnet-0ad1216eb31e15186,subnet-0a5d9eea71b9c97c6"
  SecurityGroups:
    Description: 'Security groups'
    Type: CommaDelimitedList
    Default: "sg-0a56447308e39b902,sg-078061ddab53c5c41,sg-039f822d40c446322"
  EnvironmentShort:
    Description: Environment for application
    Type: String
    Default: DEV
    AllowedValues:
      - DEV
      - EXE
      - QA
      - STG
    ConstraintDescription: Must be a valid environment.
  ProjectId:
    Description: Project ID
    Type: String
    Default: 'BT.001176'
    MinLength: '1'
    MaxLength: '255'
    AllowedPattern: '[\x20-\x7E]*'
    ConstraintDescription: Must contain only ASCII characters.
  ApplicationRole:
    Description: Application Role Tag
    Type: String
    Default: Application Server
  ExecutionRole:
    Description: ARN of execution role attached to ECS task.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-PricingSync-JobRole
  TaskRole:
    Description: ARN of task role attached to ECS task.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-PricingSync-JobRole
  DockerImageArn:
    Description: Docker image of mimix sync processor
    Type: String
    Default: 037295147636.dkr.ecr.us-east-1.amazonaws.com/cp-sync
  CPUReserved:
    Description: The number of cpu units reserved for the task. Add valid CPU, Memory combination for fargate
    Type: Number
    Default: '2048'
  MemoryReserved:
    Description: The soft limit (in MiB) of memory to reserve for the task. Add valid CPU, Memory combination for fargate
    Type: Number
    Default: '4096'
  RetentionTime:
    Description: The number of days to retain the log events in the specified log group. Possible values are 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, and 3653.
    Type: Number
    Default: '30'
    MinValue: '1'
    MaxValue: '3653'
  DesiredCount:
    Default: '1'
    Description: The task count of the ECS services
    Type: Number

Mappings:
  EnvMap:
    DEV:
      val: dev
      name: Development
    QA:
      val: qa
      name: Quality
    EXE:
      val: exe
      name: Execution
    STG:
      val: stg
      name: Staging

Resources:
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-Ecs-Cluster-'
          - !Ref 'EnvironmentShort'
      ClusterSettings:
        - Name: containerInsights
          Value: enabled

  LogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Join
        - ''
        - - '/aws/ecs/CP-Sync-Mimix-Pricing-Task'
          - !Ref 'EnvironmentShort'
      RetentionInDays: !Ref 'RetentionTime'

  ServerOneTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S1-Task-Definition-'
          - !Ref 'EnvironmentShort'
      Cpu: !Ref 'CPUReserved'
      Memory: !Ref 'MemoryReserved'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/ALL_TABLES
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_ONE
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: !Sub
                - 'Pricing-Alerts-${env}'
                - env: !Ref 'EnvironmentShort'
            - Name: 'TO_ADDRESSES'
              Value: 'chamin.wickramarathna@syscolabs.com,asanka.indunil@syscolabs.com,amoda.dissanayake@sysco.com,gothami.karunarathna@syscolabs.com,piyumi.rameshka@sysco.com,chandima.samarasinghe@syscolabs.com,chathurangi.edussuriya@syscolabs.com,osanda.hemachandra@syscolabs.com,jayani.gajanayake@syscolabs.com,muqshid.mohamed@syscolabs.com,sahan.jayawardena@syscolabs.com'

  ServerTwoTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S2-Task-Definition-'
          - !Ref 'EnvironmentShort'
      Cpu: !Ref 'CPUReserved'
      Memory: !Ref 'MemoryReserved'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/ALL_TABLES
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_TWO
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: !Sub
                - 'Pricing-Alerts-${env}'
                - env: !Ref 'EnvironmentShort'
            - Name: 'TO_ADDRESSES'
              Value: 'chamin.wickramarathna@syscolabs.com,asanka.indunil@syscolabs.com,amoda.dissanayake@sysco.com,gothami.karunarathna@syscolabs.com,piyumi.rameshka@sysco.com,chandima.samarasinghe@syscolabs.com,chathurangi.edussuriya@syscolabs.com,osanda.hemachandra@syscolabs.com,jayani.gajanayake@syscolabs.com,muqshid.mohamed@syscolabs.com,sahan.jayawardena@syscolabs.com'

  ServerThreeTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S3-Task-Definition-'
          - !Ref 'EnvironmentShort'
      Cpu: !Ref 'CPUReserved'
      Memory: !Ref 'MemoryReserved'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/ALL_TABLES
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_THREE
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: !Sub
                - 'Pricing-Alerts-${env}'
                - env: !Ref 'EnvironmentShort'
            - Name: 'TO_ADDRESSES'
              Value: 'chamin.wickramarathna@syscolabs.com,asanka.indunil@syscolabs.com,amoda.dissanayake@sysco.com,gothami.karunarathna@syscolabs.com,piyumi.rameshka@sysco.com,chandima.samarasinghe@syscolabs.com,chathurangi.edussuriya@syscolabs.com,osanda.hemachandra@syscolabs.com,jayani.gajanayake@syscolabs.com,muqshid.mohamed@syscolabs.com,sahan.jayawardena@syscolabs.com'

  ServerFourTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S4-Task-Definition-'
          - !Ref 'EnvironmentShort'
      Cpu: !Ref 'CPUReserved'
      Memory: !Ref 'MemoryReserved'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/ALL_TABLES
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_FOUR
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: !Sub
                - 'Pricing-Alerts-${env}'
                - env: !Ref 'EnvironmentShort'
            - Name: 'TO_ADDRESSES'
              Value: 'chamin.wickramarathna@syscolabs.com,asanka.indunil@syscolabs.com,amoda.dissanayake@sysco.com,gothami.karunarathna@syscolabs.com,piyumi.rameshka@sysco.com,chandima.samarasinghe@syscolabs.com,chathurangi.edussuriya@syscolabs.com,osanda.hemachandra@syscolabs.com,jayani.gajanayake@syscolabs.com,muqshid.mohamed@syscolabs.com,sahan.jayawardena@syscolabs.com'

  ServerFiveTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S5-Task-Definition-'
          - !Ref 'EnvironmentShort'
      Cpu: !Ref 'CPUReserved'
      Memory: !Ref 'MemoryReserved'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/ALL_TABLES
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_FIVE
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: !Sub
                - 'Pricing-Alerts-${env}'
                - env: !Ref 'EnvironmentShort'
            - Name: 'TO_ADDRESSES'
              Value: 'chamin.wickramarathna@syscolabs.com,asanka.indunil@syscolabs.com,amoda.dissanayake@sysco.com,gothami.karunarathna@syscolabs.com,piyumi.rameshka@sysco.com,chandima.samarasinghe@syscolabs.com,chathurangi.edussuriya@syscolabs.com,osanda.hemachandra@syscolabs.com,jayani.gajanayake@syscolabs.com,muqshid.mohamed@syscolabs.com,sahan.jayawardena@syscolabs.com'

  ServerSixTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S6-Task-Definition-'
          - !Ref 'EnvironmentShort'
      Cpu: !Ref 'CPUReserved'
      Memory: !Ref 'MemoryReserved'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/ALL_TABLES
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_SIX
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: !Sub
                - 'Pricing-Alerts-${env}'
                - env: !Ref 'EnvironmentShort'
            - Name: 'TO_ADDRESSES'
              Value: 'chamin.wickramarathna@syscolabs.com,asanka.indunil@syscolabs.com,amoda.dissanayake@sysco.com,gothami.karunarathna@syscolabs.com,piyumi.rameshka@sysco.com,chandima.samarasinghe@syscolabs.com,chathurangi.edussuriya@syscolabs.com,osanda.hemachandra@syscolabs.com,jayani.gajanayake@syscolabs.com,muqshid.mohamed@syscolabs.com,sahan.jayawardena@syscolabs.com'

  ServerSevenTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S7-Task-Definition-'
          - !Ref 'EnvironmentShort'
      Cpu: !Ref 'CPUReserved'
      Memory: !Ref 'MemoryReserved'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/ALL_TABLES
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_SEVEN
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: !Sub
                - 'Pricing-Alerts-${env}'
                - env: !Ref 'EnvironmentShort'
            - Name: 'TO_ADDRESSES'
              Value: 'chamin.wickramarathna@syscolabs.com,asanka.indunil@syscolabs.com,amoda.dissanayake@sysco.com,gothami.karunarathna@syscolabs.com,piyumi.rameshka@sysco.com,chandima.samarasinghe@syscolabs.com,chathurangi.edussuriya@syscolabs.com,osanda.hemachandra@syscolabs.com,jayani.gajanayake@syscolabs.com,muqshid.mohamed@syscolabs.com,sahan.jayawardena@syscolabs.com'

  ServerEightTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S8-Task-Definition-'
          - !Ref 'EnvironmentShort'
      Cpu: !Ref 'CPUReserved'
      Memory: !Ref 'MemoryReserved'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/ALL_TABLES
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_EIGHT
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: !Sub
                - 'Pricing-Alerts-${env}'
                - env: !Ref 'EnvironmentShort'
            - Name: 'TO_ADDRESSES'
              Value: 'chamin.wickramarathna@syscolabs.com,asanka.indunil@syscolabs.com,amoda.dissanayake@sysco.com,gothami.karunarathna@syscolabs.com,piyumi.rameshka@sysco.com,chandima.samarasinghe@syscolabs.com,chathurangi.edussuriya@syscolabs.com,osanda.hemachandra@syscolabs.com,jayani.gajanayake@syscolabs.com,muqshid.mohamed@syscolabs.com,sahan.jayawardena@syscolabs.com'

  ServerNineTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S9-Task-Definition-'
          - !Ref 'EnvironmentShort'
      Cpu: !Ref 'CPUReserved'
      Memory: !Ref 'MemoryReserved'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/ALL_TABLES
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_NINE
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: !Sub
                - 'Pricing-Alerts-${env}'
                - env: !Ref 'EnvironmentShort'
            - Name: 'TO_ADDRESSES'
              Value: 'chamin.wickramarathna@syscolabs.com,asanka.indunil@syscolabs.com,amoda.dissanayake@sysco.com,gothami.karunarathna@syscolabs.com,piyumi.rameshka@sysco.com,chandima.samarasinghe@syscolabs.com,chathurangi.edussuriya@syscolabs.com,osanda.hemachandra@syscolabs.com,jayani.gajanayake@syscolabs.com,muqshid.mohamed@syscolabs.com,sahan.jayawardena@syscolabs.com'

  ServerTenTaskDefinition:
    Type: 'AWS::ECS::TaskDefinition'
    Properties:
      Family: !Join
        - ''
        - - 'CP-Sync-Mimix-Pricing-S10-Task-Definition-'
          - !Ref 'EnvironmentShort'
      Cpu: !Ref 'CPUReserved'
      Memory: !Ref 'MemoryReserved'
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref 'ExecutionRole'
      TaskRoleArn: !Ref 'TaskRole'
      ContainerDefinitions:
        - Name: cp-sync-mimix-pricing-container
          Essential: 'true'
          Image: !Ref 'DockerImageArn'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref LogGroup
              awslogs-region: !Ref 'AWS::Region'
              awslogs-stream-prefix: ecs/ALL_TABLES
              awslogs-datetime-format: '%Y-%m-%d %H:%M:%S.%L'
          Environment:
            - Name: SERVER_ENVIRONMENT_VARIABLE
              Value: !Ref 'EnvironmentShort'
            - Name: SYNC_TYPE
              Value: ALL_TABLES
            - Name: SYNC_SERVER
              Value: MIMIX_PRICING_SERVER_TEN
            - Name: SYNC_ROLE
              Value: MIMIX_PRICING
            - Name: 'SENDER'
              Value: 'CloudPricingAlerts@corp.sysco.com'
            - Name: 'SUBJECT'
              Value: !Sub
                - 'Pricing-Alerts-${env}'
                - env: !Ref 'EnvironmentShort'
            - Name: 'TO_ADDRESSES'
              Value: 'chamin.wickramarathna@syscolabs.com,asanka.indunil@syscolabs.com,amoda.dissanayake@sysco.com,gothami.karunarathna@syscolabs.com,piyumi.rameshka@sysco.com,chandima.samarasinghe@syscolabs.com,chathurangi.edussuriya@syscolabs.com,osanda.hemachandra@syscolabs.com,jayani.gajanayake@syscolabs.com,muqshid.mohamed@syscolabs.com,sahan.jayawardena@syscolabs.com'

  ServerOneEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S1-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref Subnets
      TaskDefinition: !Ref 'ServerOneTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Sub
            - '${env}'
            - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        - Key: Technical:ApplicationSubName
          Value: !Ref 'ApplicationSubName'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
        - Key: Component
          Value: !Ref 'Component'
        - Key: Platform
          Value: !Ref 'Platform'

  ServerTwoEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S2-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref Subnets
      TaskDefinition: !Ref 'ServerTwoTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Sub
            - '${env}'
            - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        - Key: Technical:ApplicationSubName
          Value: !Ref 'ApplicationSubName'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
        - Key: Component
          Value: !Ref 'Component'
        - Key: Platform
          Value: !Ref 'Platform'

  ServerThreeEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S3-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref Subnets
      TaskDefinition: !Ref 'ServerThreeTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Sub
            - '${env}'
            - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        - Key: Technical:ApplicationSubName
          Value: !Ref 'ApplicationSubName'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
        - Key: Component
          Value: !Ref 'Component'
        - Key: Platform
          Value: !Ref 'Platform'

  ServerFourEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S4-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref Subnets
      TaskDefinition: !Ref 'ServerFourTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Sub
            - '${env}'
            - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        - Key: Technical:ApplicationSubName
          Value: !Ref 'ApplicationSubName'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
        - Key: Component
          Value: !Ref 'Component'
        - Key: Platform
          Value: !Ref 'Platform'

  ServerFiveEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S5-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref Subnets
      TaskDefinition: !Ref 'ServerFiveTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Sub
            - '${env}'
            - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        - Key: Technical:ApplicationSubName
          Value: !Ref 'ApplicationSubName'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
        - Key: Component
          Value: !Ref 'Component'
        - Key: Platform
          Value: !Ref 'Platform'

  ServerSixEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S6-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref Subnets
      TaskDefinition: !Ref 'ServerSixTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Sub
            - '${env}'
            - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        - Key: Technical:ApplicationSubName
          Value: !Ref 'ApplicationSubName'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
        - Key: Component
          Value: !Ref 'Component'
        - Key: Platform
          Value: !Ref 'Platform'

  ServerSevenEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S7-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref Subnets
      TaskDefinition: !Ref 'ServerSevenTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Sub
            - '${env}'
            - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        - Key: Technical:ApplicationSubName
          Value: !Ref 'ApplicationSubName'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
        - Key: Component
          Value: !Ref 'Component'
        - Key: Platform
          Value: !Ref 'Platform'

  ServerEightEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S8-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref Subnets
      TaskDefinition: !Ref 'ServerEightTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Sub
            - '${env}'
            - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        - Key: Technical:ApplicationSubName
          Value: !Ref 'ApplicationSubName'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
        - Key: Component
          Value: !Ref 'Component'
        - Key: Platform
          Value: !Ref 'Platform'

  ServerNineEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S9-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref Subnets
      TaskDefinition: !Ref 'ServerNineTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Sub
            - '${env}'
            - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        - Key: Technical:ApplicationSubName
          Value: !Ref 'ApplicationSubName'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
        - Key: Component
          Value: !Ref 'Component'
        - Key: Platform
          Value: !Ref 'Platform'

  ServerTenEcsService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: 'CP-Sync-Mimix-Pricing-S10-Service'
      Cluster: !Ref 'ECSCluster'
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 100
        MinimumHealthyPercent: 0
      DesiredCount: !Ref 'DesiredCount'
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref Subnets
      TaskDefinition: !Ref 'ServerTenTaskDefinition'
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - 'cp-sync-mimix-pricing-ecs-service-'
              - !Ref 'EnvironmentShort'
        - Key: Technical:ApplicationName
          Value: !Ref 'ApplicationName'
        - Key: Technical:ApplicationID
          Value: !Ref 'ApplicationId'
        - Key: Technical:PlatformOwner
          Value: !Ref 'Owner'
        - Key: Technical:Environment
          Value: !Sub
            - '${env}'
            - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        - Key: Technical:ApplicationSubName
          Value: !Ref 'ApplicationSubName'
        - Key: Technical:ApplicationRole
          Value: !Ref 'ApplicationRole'
        - Key: Support_Email
          Value: !Ref 'SupportEmail'
        - Key: 2WTAGGER
          Value: !Ref '2WTAGGER'
        - Key: Approver
          Value: !Ref 'Approver'
        - Key: PO_Number
          Value: !Ref 'PONumber'
        - Key: Project_ID
          Value: !Ref 'ProjectId'
        - Key: Component
          Value: !Ref 'Component'
        - Key: Platform
          Value: !Ref 'Platform'


Outputs:
  ClusterARN:
    Description: The ECS Cluster ARN
    Value: !GetAtt ECSCluster.Arn

#role, scale policy mapping, non-prod version
