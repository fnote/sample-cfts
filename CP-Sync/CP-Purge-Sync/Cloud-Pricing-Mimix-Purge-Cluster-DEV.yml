AWSTemplateFormatVersion: 2010-09-09
Description: This is the stack for CP Mimix Daily Purge ECS cluster
Parameters:
  PONumber:
    Description: PO Number for billing
    Type: String
    Default: 7000002358
  ApplicationID:
    Description: Application ID - Official Application_ID, this is generated by Sysco's CMDB
    Type: String
    Default: APP-001151
  ApplicationName:
    Description: Application_Name - Common, user-friendly name
    Type: String
    Default: Cloud Pricing
  ApplicationSubName:
    Description: Application_Sub_Name - Common, user-friendly name
    Type: String
    Default: CP Mimix Purge
  Component:
    Description: Component name
    Type: String
    Default: Pricing service
  Owner:
    Description: Email address usually Product/ Platform Owner, though team distribution list for technical product/platform team contact
    Type: String
    Default: krishan.senevirathne@sysco.com
  Approver:
    Description: Person approving instance funding.  This should be Email address formatted
    Type: String
    Default: villanueva.loi@corp.sysco.com
  SupportEmail:
    Description: Email distribution list for technical product/platform team contact
    Type: String
    Default: 000-BT-PricingPlatform@Corp.sysco.com
  ProjectID:
    Description: Project_ID - BT Project ID for this workload
    Type: String
    Default: BT.001176
  2WTAGGER:
    Description: Used by 2nd Watch Managed Services in shared accounts to determine if a resource is supported
    Type: String
    Default: team_managed
  Platform:
    Description: Platform
    Type: String
    Default: CP Pricing Service
  EnvironmentShort:
    Description: Environment for application
    Type: String
    Default: DEV
  ExecutionRole:
    Description: ARN of execution role attached to ECS task.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-Mimix-Purge-Job-Role
  TriggeringRole:
    Description: ARN of triggering role attached to cloud watch Events.
    Type: String
    Default: arn:aws:iam::037295147636:role/CloudPricing-Mimix-Purge-Triggering-Role
  MimixPurgeServiceRole:
    Description: ARN of triggering role attached to cloud watch Events.
    Type: String
    Default: arn:aws:iam::037295147636:role/Cloud-Pricing-Mimix-Purge-Service-Role
  JobDefinitionArn:
    Description: Job Definition Arn
    Type: String
    Default: arn:aws:batch:us-east-1:037295147636:job-definition/CP-Mimix-Purge-Job-Definition-DEV
  PvtSNa:
    Description: 'Private PRCP-NP Confidential Subnet 1 in us-east-1a CIDR: 10.133.103.0/24'
    Type: String
    Default: subnet-0186b43162a344d9a
  PvtSNb:
    Description: 'Private PRCP-NP Confidential Subnet 2 in us-east-1b CIDR: 10.133.105.0/24'
    Type: String
    Default: subnet-0ad1216eb31e15186
  PvtSNc:
    Description: 'Private PRCP-NP Confidential Subnet 3 in us-east-1c CIDR: 10.133.106.0/24'
    Type: String
    Default: subnet-0a5d9eea71b9c97c6
  SGDNS:
    Description: PRCP-NP-DNS-DNSSG-3J5600OVNNBR
    Type: String
    Default: sg-078061ddab53c5c41
  SGRDSMySQL:
    Description: SG-RDSMySQL
    Type: String
    Default: sg-039f822d40c446322
  SGWebServices:
    Description: SG-WebServices
    Type: String
    Default: sg-0a56447308e39b902
  RootVolumeSize:
    Description: Root Volume Size
    Type: String
    Default: 80
  ComputeEnvironmentNamePrefix:
    Description: Compute environment name prefix
    Type: String
    Default: CP-Mimix-Purge-Sync-Compute-Environment-
  ApplicationRole:
    Description: Application Role Tag
    Type: String
    Default: Application Server
  RetentionTime:
    Description: The number of days to retain the log events in the specified log group. Possible values are 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, and 3653.
    Type: Number
    Default: '30'
    MinValue: '1'
    MaxValue: '3653'

Mappings:
  EnvMap:
    DEV:
      val: dev
      name: Development

Resources:
  MimixDailyPurgeSync001:
    Type: AWS::Events::Rule
    Properties:
      Description: "Mimix Daily Purge Sync for 001"
      Name: !Sub "Mimix-Daily-Purge-Sync-${EnvironmentShort}-001-Trigger"
      State: DISABLED
      ScheduleExpression: 'cron(30 05 * * ? *)'
      RoleArn: !Ref 'TriggeringRole'
      Targets:
        - Arn: !Ref 'JobQueue'
          Id: EC2
          Input: '{"Parameters": {"business_unit": "001"}}'
          RoleArn: !Ref 'TriggeringRole'
          BatchParameters:
            JobDefinition: !Ref 'JobDefinitionArn'
            JobName: '001-Purge-Sync-Job'

  MimixDailyPurgeSync002:
    Type: AWS::Events::Rule
    Properties:
      Description: "Mimix Daily Purge Sync for 002"
      Name: !Sub "Mimix-Daily-Purge-Sync-${EnvironmentShort}-002-Trigger"
      State: DISABLED
      ScheduleExpression: 'cron(45 03 * * ? *)'
      RoleArn: !Ref 'TriggeringRole'
      Targets:
        - Arn: !Ref 'JobQueue'
          Id: EC2
          Input: '{"Parameters": {"business_unit": "002"}}'
          RoleArn: !Ref 'TriggeringRole'
          BatchParameters:
            JobDefinition: !Ref 'JobDefinitionArn'
            JobName: '002-Purge-Sync-Job'

  MimixDailyPurgeSync019:
    Type: AWS::Events::Rule
    Properties:
      Description: "Mimix Daily Purge Sync for 019"
      Name: !Sub "Mimix-Daily-Purge-Sync-${EnvironmentShort}-019-Trigger"
      State: ENABLED
      ScheduleExpression: 'cron(07 10 ? * MON-SAT *)'
      RoleArn: !Ref 'TriggeringRole'
      Targets:
        - Arn: !Ref 'JobQueue'
          Id: EC2
          Input: '{"Parameters": {"business_unit": "019"}}'
          RoleArn: !Ref 'TriggeringRole'
          BatchParameters:
            JobDefinition: !Ref 'JobDefinitionArn'
            JobName: '056-Purge-Sync-Job'

  MimixDailyPurgeSync022:
    Type: AWS::Events::Rule
    Properties:
      Description: "Mimix Daily Purge Sync for 022"
      Name: !Sub "Mimix-Daily-Purge-Sync-${EnvironmentShort}-022-Trigger"
      State: ENABLED
      ScheduleExpression: 'cron(08 30 ? * MON-SAT *)'
      RoleArn: !Ref 'TriggeringRole'
      Targets:
        - Arn: !Ref 'JobQueue'
          Id: EC2
          Input: '{"Parameters": {"business_unit": "022"}}'
          RoleArn: !Ref 'TriggeringRole'
          BatchParameters:
            JobDefinition: !Ref 'JobDefinitionArn'
            JobName: '056-Purge-Sync-Job'

  MimixDailyPurgeSync056:
    Type: AWS::Events::Rule
    Properties:
      Description: "Mimix Daily Purge Sync for 056"
      Name: !Sub "Mimix-Daily-Purge-Sync-${EnvironmentShort}-056-Trigger"
      State: ENABLED
      ScheduleExpression: 'cron(08 10 ? * MON-SAT *)'
      RoleArn: !Ref 'TriggeringRole'
      Targets:
        - Arn: !Ref 'JobQueue'
          Id: EC2
          Input: '{"Parameters": {"business_unit": "056"}}'
          RoleArn: !Ref 'TriggeringRole'
          BatchParameters:
            JobDefinition: !Ref 'JobDefinitionArn'
            JobName: '056-Purge-Sync-Job'

  MimixDailyPurgeSync067:
    Type: AWS::Events::Rule
    Properties:
      Description: "Mimix Daily Purge Sync for 067"
      Name: !Sub "Mimix-Daily-Purge-Sync-${EnvironmentShort}-067-Trigger"
      State: ENABLED
      ScheduleExpression: 'cron(05 50 ? * MON-SAT *)'
      RoleArn: !Ref 'TriggeringRole'
      Targets:
        - Arn: !Ref 'JobQueue'
          Id: EC2
          Input: '{"Parameters": {"business_unit": "067"}}'
          RoleArn: !Ref 'TriggeringRole'
          BatchParameters:
            JobDefinition: !Ref 'JobDefinitionArn'
            JobName: '056-Purge-Sync-Job'

  MimixPurgeComputeEnvironment:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      Type: MANAGED
      ServiceRole:
        Ref: 'MimixPurgeServiceRole'
      ComputeEnvironmentName:
        Fn::Join:
          - ''
          - - Ref: 'ComputeEnvironmentNamePrefix'
            - Ref: 'EnvironmentShort'
      ComputeResources:
        MaxvCpus: 22
        SecurityGroupIds:
          - !Ref 'SGDNS'
          - !Ref 'SGWebServices'
          - !Ref 'SGRDSMySQL'
        Type: FARGATE
        Subnets:
          - !Ref 'PvtSNa'
          - !Ref 'PvtSNb'
          - !Ref 'PvtSNc'
      Tags:
        Technical:ApplicationName:
          Ref: 'ApplicationName'
        Technical:ApplicationID:
          Ref: 'ApplicationID'
        Technical:PlatformOwner:
          Ref: 'Owner'
        Technical:Environment: !Sub
        - '${env}'
        - { env: !FindInMap [ EnvMap, !Ref EnvironmentShort, name ] }
        Technical:ApplicationSubName:
          Ref: 'ApplicationSubName'
        Technical:ApplicationRole:
          Ref: 'ApplicationRole'
        Approver:
          Ref: 'Approver'
        PO_Number:
          Ref: 'PONumber'
        Project_ID:
          Ref: 'ProjectID'
        Support_Email:
          Ref: 'SupportEmail'
        2WTAGGER:
          Ref: '2WTAGGER'
        Platform:
          Ref: 'Platform'
        Name:
          Ref: 'ApplicationSubName'
        Component:
          Ref: 'Component'
      State: ENABLED

  JobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      State: ENABLED
      JobQueueName:
        Fn::Join:
          - ''
          - - CP-Mimix-Purge-Job-Queue-
            - Ref: 'EnvironmentShort'
      Priority: 50
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment:
            Ref: 'MimixPurgeComputeEnvironment'
